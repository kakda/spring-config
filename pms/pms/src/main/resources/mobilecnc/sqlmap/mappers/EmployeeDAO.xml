<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobilecnc.employees.service.EmployeeDAO">
	
	<resultMap id="employee" type="Employee">
        <result property="employeeID" column="employeeID"/>
		<result property="employeeName" column="employeeName"/>
		<result property="companyID" column="companyID"/>
		<result property="type" column="type"/>
		<result property="titleID" column="titleID"/>
		<result property="roleID" column="roleID"/>
		<result property="email" column="email"/>
		<result property="mobilePhone" column="mobilePhone"/>
		<result property="companyPhone" column="companyPhone"/>
		<result property="address" column="address"/>
		<result property="entryDate" column="entryDate"/>
		<result property="entryBy" column="entryBy"/>
		<result property="lastModifyDate" column="lastModifyDate"/>
		<result property="lastModifyBy" column="lastModifyBy"/>
		<result property="joinDate" column="joinDate"/>
		<result property="quitDate" column="quitDate"/>
		<result property="quitReason" column="quitReason"/>
		<result property="teamID" column="teamID"/>
		<result property="titleName" column="titleName"/>
    	<result property="roleName" column="roleName"/>
    	<result property="teamName" column="teamName"/>
    	<result property="activeUser" column="active"/>
    	<result property="skillID" column="skillID"/>
    </resultMap>
    
    <resultMap id="employeeList" type="Employee">
        <result property="employeeID" column="employeeID"/>
		<result property="employeeName" column="employeeName"/>
    </resultMap>
    
    <resultMap id="projectGrid" type="Employee">
    	<result property="employeeID" column="employeeID"/>
    	<result property="employeeName" column="employeeName"/>
    	<result property="titleName" column="titleName"/>
    	<result property="roleName" column="roleName"/>
    	<result property="teamName" column="teamName"/>
    </resultMap>
	
	<resultMap type="EmployeeVO" id="username">
		<result property="userName" column="username"/>
	</resultMap>
	
	<resultMap id="skill" type="Employee">
		<result property="skillID" column="skillID"/>
	</resultMap>
	<select id="selectEmployeeList" resultMap="employeeList" parameterType="com.mobilecnc.employees.service.EmployeeVO">  	
			SELECT employeeID, employeeName FROM Employees 
			<where>
				<if test="roleID != null">
					roleID = #{roleID}	
				</if>
				<if test="type != null">
					and type = #{type}	
				</if>
			</where>
	</select>
	
	<insert id="insertEmployee">
		<![CDATA[
			INSERT INTO Employees
			VALUES
			( #{employeeID}, #{employeeName}, #{companyID},#{type},#{titleID},#{roleID},#{email},#{mobilePhone},#{companyPhone},#{address},getDate(),#{entryBy},getDate(),#{lastModifyBy},#{teamID})			
		]]>
	</insert>
	
	<insert id="insertUser">
		<![CDATA[
			INSERT INTO Users
			VALUES
			(#{employeeID},#{userName},NULL,1,#{roleID},getDate(),#{entryBy},getDate(),#{lastModifyBy})
		]]>
	</insert>
	
	<insert id="insertEmployeeHistory">
		<![CDATA[
			INSERT INTO EmployeeHistory
			VALUES
			( #{employeeID},#{joinDate},#{quitDate},#{quitReason})
		]]>
	</insert>
	
	<insert id="insertEmployeeSkill">
		<![CDATA[
			INSERT INTO EmployeeSkills
			VALUES
			( #{employeeID},#{skillID})
		]]>
	</insert>
	
	<update id="updateEmployee" parameterType="employee">
		UPDATE Employees
		SET
			employeeName = #{employeeName},
			companyID = #{companyID},
			type = #{type},
			titleID = #{titleID},
			roleID = #{roleID},
			email = #{email},
			mobilePhone = #{mobilePhone},
			companyPhone = #{companyPhone},
			address = #{address},
			lastModifyDate = getDate(),
			lastModifyBy = #{lastModifyBy},
			teamID = #{teamID}
		WHERE
			employeeID = #{employeeID}
	</update>
	
	<update id="updateEmployeeHistory" parameterType="employee">
		UPDATE EmployeeHistory
		SET
			joinDate = #{joinDate},
			quitDate = #{quitDate},
			quitReason = #{quitReason}
		WHERE no=(SELECT MAX(no) FROM EmployeeHistory WHERE employeeID=#{employeeID})
	</update>
	
	<select id="getPagingRecord" resultMap="projectGrid"  parameterType="com.mobilecnc.helper.PagingCondition">
		<!-- SELECT *
		FROM VEmployees
		WHERE RowNr BETWEEN #{start} AND #{end} ${where}
		ORDER BY ${sidx} ${sord} -->
		
		SELECT * FROM
		(SELECT ROW_NUMBER() OVER (ORDER BY employeeID) RowNr,employeeID,employeeName,titleName,roleName,teamName
		FROM VEmployees		
		<where>
			<if test="col != null">
				${where}
			</if>
		</where>
		) AS VTables
		WHERE RowNr BETWEEN #{start} AND #{end}  
		ORDER BY ${sidx} ${sord}
		
		<!-- SELECT * FROM (
		SELECT ROW_NUMBER() OVER (ORDER BY employeeID) RowNr, employeeID, employeeName, titleName, roleName, teamName
		FROM (SELECT DISTINCT employeeID, employeeName, titleName, roleName, teamName
              FROM dbo.VEmployeesReport 
              <where>
              	<if test="where != null">
				${where}
				</if>
              </where>
              ) AS VTables
              ) AS VTables2
        WHERE RowNr BETWEEN #{start} AND #{end}  
		ORDER BY ${sidx} ${sord} -->
		
	</select>
	
	<select id="getRecordCount" resultType="int" parameterType="com.mobilecnc.helper.PagingCondition" >
			SELECT COUNT(employeeID) FROM VEmployees 
			<where>
				<if test="col != null"> 
					${col} ${oper} ${val}
				</if>
			</where> 
			
			<!-- SELECT COUNT(employeeID) FROM (
			SELECT DISTINCT employeeID, employeeName, titleName, roleName, teamName
              FROM dbo.VEmployeesReport 
              <where>
              	<if test="where != null">
				${where}
				</if>
              </where>
			) AS VTables -->
			
	</select>
	
	<select id="deleteEmployee" parameterType="java.lang.String">
		<![CDATA[
			DELETE FROM Employees
			WHERE employeeID = #{employeeID};			
		]]>
	</select>
	
	<select id="deleteEmployeeHistory" parameterType="java.lang.String">
		<![CDATA[
			DELETE FROM EmployeeHistory
			WHERE employeeID = #{employeeID};			
		]]>
	</select>
	
	<select id="getEmployee" parameterType="java.lang.String" resultMap="employee">
			<!-- SELECT *, EmployeeHistory.joinDate, EmployeeHistory.quitDate
			FROM Employees 
			     Left JOIN EmployeeHistory on Employees.employeeID=EmployeeHistory.employeeID
			where Employees.employeeID=#{employeeID} -->
			
			SELECT Employees.*, EmployeeHistory.joinDate, EmployeeHistory.quitDate, Titles.titleName, Roles.roleName, Teams.teamName, Companies.companyName
			FROM Employees 
				LEFT JOIN EmployeeHistory ON Employees.employeeID = EmployeeHistory.employeeID 
				LEFT JOIN Titles ON Employees.titleID = Titles.titleID 
                LEFT JOIN Roles ON Employees.roleID = Roles.roleID 
                LEFT JOIN Companies ON Employees.companyID = Companies.companyID 
                LEFT JOIN Teams ON Employees.teamID = Teams.teamID
            WHERE Employees.employeeID = #{employeeID} AND type='employee'
            AND no = (SELECT MAX(no) FROM EmployeeHistory WHERE employeeID = #{employeeID})
			
	</select>
	
	<select id="getSkill" resultMap="skill" resultType="com.mobilecnc.employees.service.EmployeeVO">
		SELECT skillID
			FROM EmployeeSkills
		where employeeID=#{employeeID}
	</select>
	
	<select id="deleteEmployeeSkill" parameterType="java.lang.String">
		<![CDATA[
			DELETE FROM EmployeeSkills
			WHERE employeeID = #{employeeID};			
		]]>
	</select>
	
	<select id="checkExisName" resultType="int">
		SELECT COUNT(username) FROM Users
		<where>
			<if test="employeeID != null">
				employeeID <![CDATA[<>]]> #{employeeID}
			</if>
			<if test="userName != null">
				AND username LIKE #{userName}
			</if>
		</where>
	</select>
	
	<select id="getUser" resultMap="username">
		SELECT username 
		FROM Users
	</select>
	
	<resultMap id="employeeYear" type="Employee">
    	<result property="employeeYear" column="employeeYear"/>
    </resultMap>
	
	<select id="selectEmployeeYear" parameterType="java.lang.String" resultMap="employeeYear">
		<![CDATA[
		SELECT number AS employeeYear
FROM master.dbo.spt_values
WHERE (number BETWEEN (SELECT MIN(YEAR(joinDate)) FROM EmployeeHistory) AND YEAR(GETDATE())) AND (type = 'P')
		]]>
	</select>
	
	<resultMap id="reportGrid" type="Employee">
    	<result property="employeeID" column="employeeID"/>
    	<result property="employeeName" column="employeeName"/>
    	<result property="companyName" column="companyName"/>
    	<result property="type" column="type"/>
    	<result property="titleName" column="titleName"/>
    	<result property="grade" column="grade"/>
    	<result property="joinDate" column="joinDate"/>
    	<result property="quitDate" column="quitDate"/>
    	<result property="email" column="email"/>
		<result property="mobilePhone" column="mobilePhone"/>
		<result property="skillNames" column="skillNames"/>
    </resultMap>
	
	<select id="getPagingReportRecord" resultMap="reportGrid"  parameterType="com.mobilecnc.helper.PagingCondition">
	
		SELECT * FROM (
		SELECT 
		ROW_NUMBER() OVER (ORDER BY employeeID) RowNr, 
		employeeID, 
		employeeName, 
		companyName,
		type, 
		titleName, 
		grade, 
		email, 
		mobilePhone, 
		skillNames, 
		joinDate, 
		quitDate
		FROM VEmployeesReport1
		<where>
        	<if test="where != null">
			${where} 
			</if>
        </where>
		) VTables
        WHERE RowNr BETWEEN #{start} AND #{end}
        <!-- ORDER BY ${sidx} ${sord} -->
        ORDER BY type DESC, employeeName, employeeID, joinDate
		
	</select>
	
	<select id="getReportRecordCount" resultType="int" parameterType="com.mobilecnc.helper.PagingCondition" >
			
		SELECT COUNT(employeeID) FROM (
		SELECT employeeID
		FROM dbo.VEmployeesReport1
		<where>
			<if test="where != null">
			${where} 
			</if>
		</where>
		) AS VTables
			
	</select>
	
	<select id="getTotalReportRecord" resultMap="reportGrid" parameterType="com.mobilecnc.helper.PagingCondition">
		SELECT * FROM (
		SELECT 
		ROW_NUMBER() OVER (ORDER BY employeeID) RowNr, 
		employeeID, 
		employeeName, 
		companyName,
		type, 
		titleName, 
		grade, 
		email, 
		mobilePhone, 
		skillNames, 
		joinDate, 
		quitDate
		FROM VEmployeesReport1
		<where>
        	<if test="where != null">
			${where} 
			</if>
        </where>
		) VTables
        <!-- ORDER BY ${sidx} ${sord} -->
        ORDER BY type DESC, employeeName, employeeID, joinDate
		
	</select>
	
</mapper>