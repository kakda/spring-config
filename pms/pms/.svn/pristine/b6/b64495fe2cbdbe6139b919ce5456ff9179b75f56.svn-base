<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mobilecnc.contractors.service.ContractorDAO">
	
 	<resultMap id="contractor" type="Contractor">
        <result property="employeeID" column="employeeID"/>
		<result property="employeeName" column="employeeName"/>
		<result property="companyID" column="companyID"/>
		<result property="type" column="type"/>
		<result property="titleID" column="titleID"/>
		<result property="roleID" column="roleID"/>
		<result property="email" column="email"/>
		<result property="mobilePhone" column="mobilePhone"/>
		<result property="companyPhone" column="companyPhone"/>
		<result property="address" column="address"/>
		<result property="entryDate" column="entryDate"/>
		<result property="entryBy" column="entryBy"/>
		<result property="lastModifyDate" column="lastModifyDate"/>
		<result property="lastModifyBy" column="lastModifyBy"/>
		<result property="joinDate" column="joinDate"/>
		<result property="quitDate" column="quitDate"/>
		<result property="quitReason" column="quitReason"/>
		<result property="teamID" column="teamID"/>
		<result property="titleName" column="titleName"/>
    	<result property="roleName" column="roleName"/>
    	<result property="teamName" column="teamName"/>
    	<result property="activeUser" column="active"/>
    </resultMap>
    
   <resultMap id="skill" type="Contractor">
		<result property="skillID" column="skillID"/>
	</resultMap>
    
    <resultMap id="projectGrid" type="Contractor">
    	<result property="employeeID" column="employeeID"/>
    	<result property="employeeName" column="employeeName"/>
    	<result property="titleName" column="titleName"/>
    	<result property="roleName" column="roleName"/>
    	<result property="teamName" column="teamName"/>
    	<result property="joinDate" column="joinDate"/>
		<result property="quitDate" column="quitDate"/>
    </resultMap>
	
	<resultMap id="password" type="contractor">
		<result property="employeeID" column="employeeID"/>
		<result property="password" column="password"/>
	</resultMap>
	
	
	<select id="getPagingRecord" resultMap="projectGrid"  parameterType="com.mobilecnc.helper.PagingCondition">
		<!-- SELECT 
			 employeeID
			 , employeeName
			 , titleName
			 , roleName 
             , teamName
		FROM VContractors
		WHERE RowNr BETWEEN #{start} AND #{end} ${where} 
		ORDER BY ${sidx} ${sord} -->
		SELECT * FROM
		(SELECT ROW_NUMBER() OVER (ORDER BY employeeID) RowNr,employeeID,employeeName,titleName,roleName,teamName,joinDate,quitDate
		FROM VContractors		
		<where>
			<if test="col != null">
				${where}
			</if>
		</where>
		) AS VTables
		WHERE RowNr BETWEEN #{start} AND #{end}  
		ORDER BY ${sidx} ${sord}
	</select>
	
	<select id="getRecordCount" resultType="int" parameterType="com.mobilecnc.helper.PagingCondition">
			SELECT COUNT(employeeID) FROM VContractors
			<where>
				<if test="col != null"> 
					${col} ${oper} ${val}
				</if>
			</where> 
	</select>
	
	<select id="deleteContractor">
		<![CDATA[
			DELETE FROM Employees
			WHERE employeeID = #{employeeID};			
		]]>
	
	</select>
	
	<insert id="insertContractor">
		<![CDATA[
			INSERT INTO Employees
			VALUES
			( #{employeeID}, #{employeeName}, #{companyID},#{type},#{titleID},#{roleID},#{email},#{mobilePhone},#{companyPhone},#{address},getDate(),#{entryBy},getDate(),#{lastModifyBy},#{teamID})			
		]]>
	</insert>
	
	<insert id="insertUser">
		<![CDATA[
			INSERT INTO Users
			VALUES
			(#{employeeID},#{userName},#{password},1,#{roleID},getDate(),#{entryBy},getDate(),#{lastModifyBy})
		]]>
	</insert>
	
	<insert id="insertContractorHistory">
		<![CDATA[
			INSERT INTO EmployeeHistory
			VALUES
			( #{employeeID},#{joinDate},#{quitDate},#{quitReason})
		]]>
	</insert>
	
	<insert id="insertContractorSkill">
		<![CDATA[
			INSERT INTO EmployeeSkills
			VALUES
			( #{employeeID},#{skillID})
		]]>
	</insert>
	
	<select id="getEmployee" parameterType="java.lang.String" resultMap="contractor">
			<!-- SELECT *, EmployeeHistory.joinDate, EmployeeHistory.quitDate
			FROM Employees 
			     Left JOIN EmployeeHistory on Employees.employeeID=EmployeeHistory.employeeID
			where Employees.employeeID=#{employeeID} -->
			
			SELECT DISTINCT Employees.*, EmployeeHistory.joinDate, EmployeeHistory.quitDate, Titles.titleName, Roles.roleName, Teams.teamName, Companies.companyName
			FROM Employees 
				LEFT JOIN EmployeeHistory ON Employees.employeeID = EmployeeHistory.employeeID 
				LEFT JOIN Titles ON Employees.titleID = Titles.titleID 
                LEFT JOIN Roles ON Employees.roleID = Roles.roleID 
                LEFT JOIN Companies ON Employees.companyID = Companies.companyID 
                LEFT JOIN Teams ON Employees.teamID = Teams.teamID
            WHERE Employees.employeeID = #{employeeID} AND type='contractor'
            AND no = (SELECT MAX(no) FROM EmployeeHistory WHERE employeeID = #{employeeID})
			
	</select>
	
	<select id="getSkill" resultMap="skill" resultType="com.mobilecnc.employees.service.EmployeeVO">
		SELECT skillID
			FROM EmployeeSkills
		where employeeID=#{employeeID}
	</select>
	
	<update id="updateContractor" parameterType="contractor">
		UPDATE Employees
		SET
			employeeName = #{employeeName},
			companyID = #{companyID},
			type = #{type},
			titleID = #{titleID},
			roleID = #{roleID},
			email = #{email},
			mobilePhone = #{mobilePhone},
			companyPhone = #{companyPhone},
			address = #{address},
			lastModifyDate = getDate(),
			lastModifyBy = #{lastModifyBy},
			teamID = #{teamID}
		WHERE
			employeeID = #{employeeID}
	</update>
	
	<update id="updateContractorHistory" parameterType="contractor">
		UPDATE EmployeeHistory
		SET
			joinDate = #{joinDate},
			quitDate = #{quitDate},
			quitReason = #{quitReason}
		WHERE no=(SELECT MAX(no) FROM EmployeeHistory WHERE employeeID=#{employeeID})
	</update>
	
	<select id="deleteContractorSkill" parameterType="java.lang.String">
		<![CDATA[
			DELETE FROM EmployeeSkills
			WHERE employeeID = #{employeeID};			
		]]>
	</select>
	
	<select id="getPassword" resultMap="password">
		SELECT employeeID,password 
			FROM Users 
			WHERE employeeID = #{employeeID};
	</select>
	
	<!-- Chamroeun -->
	
	<resultMap id="employeeSkillList" type="Skill">
		<result property="skillID" column="skillID"/>
		<result property="skillName" column="skillName"/>
	</resultMap>
	
	<select id="getEmployeeSkills" resultMap="employeeSkillList">
		<![CDATA[
			SELECT Skills.skillID, Skills.skillName
			FROM Employees
			INNER JOIN EmployeeSkills ON Employees.employeeID = EmployeeSkills.employeeID 
			INNER JOIN Skills ON EmployeeSkills.skillID = Skills.skillID
			WHERE (Employees.employeeID = #{employeeID})
		]]>
	</select>
	
</mapper>