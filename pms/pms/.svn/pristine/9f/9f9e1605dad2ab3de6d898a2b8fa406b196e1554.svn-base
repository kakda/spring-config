<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<link rel="stylesheet" href="<c:url value='/css/fullcalendar.css'/>"type="text/css" />
<link rel="stylesheet" href="<c:url value='/css/fullcalendar.print.css'/>"type="text/css"  media='print' />
<script src="<c:url value='/js/calender/fullcalendar.min-${pageContext.response.locale}.js'/>" type="text/javascript"></script>

<style>
		.popup h1{font-size: 1em;}
		.popup label{padding:5px 5px 5px 8px}
		.popup input[type="text"]{float:right;height:25px;width:60%;padding: 0 10px;margin-left: 20px;}
		.popup button[type="button"]{margin-left: 20px}
		.bottom-prong .prong-dk, .bottom-prong .prong-lt {
			border-bottom-width: 0;
		}
		.hide{display:none}
		.prong-dk, .prong-lt {
			position: absolute;
			left: 0;
			top: 0;
		}
		.prong-lt {
			border: 8px solid;
			border-color: #fff transparent;
			left: 1px;
		}
		.prong-dk {
			border: 9px solid;
			border-color: #ccc transparent;
		}
		.bottom-prong {
			position: absolute;
			height: 9px;
			width: 18px;
			overflow: hidden;
		}
		 .hilight {
   			 background: yellow;
  		}
  		#tab table th{
  			background-color: #ccc;
  		}
  		#tab li .ui-icon-close { float: left; margin: 0.4em 0.2em 0 0; cursor: pointer }
</style>
<script>

	$(document).ready(function() {
		
		var tabSelection = 0;
		
		$( ".dateText" ).datepicker({
			changeMonth: true,
		});
		$(".dateText").datepicker("disable");
		
		var calendar = $('#calendar').fullCalendar({
			header: {
				left: 'today',
				center: 'prev,title,next ',
				right: 'month,agendaWeek',
			},
			selectable: true,
			selectHelper: true,
			select: function(start, end, allDay,jsEvent, view) {
				$('.save').removeClass('hide');
				$('.edit,.delete').addClass('hide');
				$(".bubblemain").dialog("close");
				$( ".bubblemain" ).dialog({
					 position: {
						 my: "bottom",
						 of: jsEvent,
						 collision: "fix"
					 },
			    	 open: function() {
			    		 $("input[type='text']").val('');
			    		 $('.dateText').val($.fullCalendar.formatDate(start,"yyyy-MM-dd"));
			    		 $(".dateText").datepicker("enable");
			    		 $('.save').unbind();
			    		 $(".save").bind('click',function(e){
			    			 var text = $('.value').val();
			    			 var startedDate = $.fullCalendar.parseISO8601($('#startDate').val()); 
			    			 var endedDate = $.fullCalendar.parseISO8601($('#endDate').val());
			    			 saveCalender(text,startedDate,endedDate,allDay);
			    			 $(".bubblemain").dialog("close");
			    		 });	
					 },
					 close: function(){
						 $(".dateText").datepicker("disable");
						 calendar.fullCalendar('unselect');
					 }
				});

				$(".bubblemain").dialog("open");

			},
			viewRender : function(view,element){
				console.log(view.title);
			},
			eventClick : function(calEvent, jsEvent, view) {
				$(".bubblemain").dialog("close");
				$('.edit,.delete').removeClass('hide');
				$('.save').addClass('hide');
				$( ".bubblemain" ).dialog({
					 position: {
						 my: "bottom",
						 of: jsEvent,
						 collision: "fix"
					 },
			    	 open: function() {
			    		 $('#startDate').val($.fullCalendar.formatDate(calEvent.start,"yyyy-MM-dd"));
			    		 $('#endDate').val($.fullCalendar.formatDate((calEvent.end!=null)?calEvent.end:calEvent.start,"yyyy-MM-dd"));
			    		 $('.value').val(calEvent.title);
			    		 $('.edit').unbind();
			    		 $(".dateText").datepicker("enable");
			    		 $(".edit").bind('click',function(e){
			    			 calEvent.title =  $('.value').val();
			    			 calEvent.start = $.fullCalendar.parseISO8601($('#startDate').val()); 
			    			 calEvent.end = $.fullCalendar.parseISO8601($('#endDate').val());
			    			 updateCalender(calEvent);
			    			 $(".bubblemain").dialog("close");
			    		 });
			    		 $('.delete').unbind();
			    		 $(".delete").bind('click',function(e){
			    			 deleteCalender(calEvent);
			    			 $(".bubblemain").dialog("close");
			    		 })
			    		 
					 },
					 close: function(){
						 $(".dateText").datepicker("disable");
						 calendar.fullCalendar('unselect');
					 }
					});
				$(".bubblemain").dialog("open");
			},
			eventDrop : function(event, dayDelta, minuteDelta, allDay, revertFunc, jsEvent, ui, view) {
				updateCalender(event);
			},
			loading : function(isLoading,view){
				if(isLoading){
					 $("#loading").show();
				}else{
					 $("#loading").hide();
				}
			},
			editable : true,
			events : function(start, ends, callback){
				var data = {
						"startDate" : start.getTime(),
						"endDate" : ends.getTime()
				}
				$.ajax({
					type : "POST",
					url : "<c:url value='/calender/ajaxGetCalender.html' />",
					dataType : "json",
					contentType : "application/json",
					data : JSON.stringify(data),
					success : function(event){
						var eventData = [];
						$.each(event,function(key,value){
							eventData.push({
								id : value.holidayId,
								start : new Date(value.startDate),
								end : new Date(value.endDate),
								title : value.holidayTitle,
								allDay : true
							});
						});
					callback(eventData);
					}
				});
			}
		});
		$(".bubblemain").dialog({
			autoOpen : false,
			resizable : false,
			width : 397,
			height : 180
		});
		$(".popupDialog").dialog({
			autoOpen : false,
			resizable : true,
			modal : true,
			buttons: {
				"<spring:message code='dialog.button.ok'/>" : function(){
					$.ajax({
						type : "POST",
						url : "<c:url value='/calender/copyCalender.html' />",
						dataType : "json",
						contentType : "application/json",
						success : function(event){
							if(event){
								$('.fc-button-agendaWeek').click();
								$(".popupDialog").dialog("close");
							}
						}
					});
				},
				"<spring:message code='dialog.button.cancel'/>" : function(){
					$(".popupDialog").dialog("close");
				}
			},
			close: function() {
				 $(".popupDialog").dialog("close");
	      	}
		});
		$(".bubblemain").dialog("widget").find(".ui-dialog-titlebar").css({
			"float" : "right",
			border : 0,
			padding : 0
		}).find(".ui-dialog-title").css({
			display : "none"
		}).end().find(".ui-dialog-titlebar-close").css({
			top : 0,
			right : 0,
			margin : 0,
			"z-index" : 999
		});
		function saveCalender(text,start,end,allDay){
			var data = {
					"startDate" : start.getTime(),
					"endDate" : end.getTime(),
					"holidayTitle" : text
			}
			$.ajax({
				type : "POST",
				url : "<c:url value='/calender/doadd.html' />",
				dataType : "json",
				contentType : "application/json",
				data : JSON.stringify(data),
				success : function(json){
					console.log(json);
					calendar.fullCalendar('renderEvent',
				 		{	title: text,
				 			start: start,
				 			end: end,
				 			allDay: true,
				 			id : json.holidayId
			 			}
					);
				}
			});
			
		}
		function updateCalender(calEvent){
			 var data = {
						"startDate" : calEvent.start.getTime(),
						"endDate" : (calEvent.end == null)? calEvent.start.getTime():calEvent.end.getTime(),
						"holidayTitle" : calEvent.title,
						"holidayId" : calEvent.id
				}
			 $.ajax({
					type : "POST",
					url : "<c:url value='/calender/doUpdate.html' />",
					dataType : "json",
					contentType : "application/json",
					data : JSON.stringify(data),
					success : function(json){
						 calendar.fullCalendar('updateEvent', calEvent);
					}
				});
		}
		function deleteCalender(calEvent){
			var data = {
					"holidayId" : calEvent.id
			}
			$.ajax({
				type : "POST",
				url : "<c:url value='/calender/doDelete.html' />",
				dataType : "json",
				contentType : "application/json",
				data : JSON.stringify(data),
				success : function(json){
					calendar.fullCalendar('removeEvents',calEvent.id);
				}
			});
		
		}
		$('.fc-button-agendaWeek').click(function(){
			$('.fc-view-agendaWeek').html('');
			$('.fc-header-title h2').text('<spring:message code="lbl.holidayList"/>');
			$('.fc-button-prev,.fc-button-next,.fc-button-today').addClass('hide');
			$.ajax({
				type: 'post',
				url : "<c:url value='/calender/getHistory.html'/>",
				dataType : "json",
				contentType: 'application/json',
				success : function(json){
					$( "#tab").tabs( "destroy" );
					tabGenerator(json);
				}
			});
			
		});
		$('.fc-button-month').click(function(){
			$('.fc-button-prev,.fc-button-next,.fc-button-today').removeClass('hide');
			$( "#tab" ).addClass('hide');
			$( "#tab" ).tabs( "destroy" );
			$('#calendar').fullCalendar( 'refetchEvents' );
		});
		
		function tabGenerator(json){
			$('#tab').tabs('refresh');
			var html = '';
			html +='<ul>';
			$.each(json,function(key,value){
				html +="<li key="+key+"><a href='#"+key+"'>"+key+"";
				html +="</a><span class='ui-icon ui-icon-close'>s</span></li>";
			});
			html +="<li><a id='tabAdd' href='#addTab'>"+ "+" +"</a></li>" ;
			html += '</ul>';
			$.each(json,function(key,value){
				html +="<div id='"+key+"'>";
				html +="<table id='test'>";
				html +="<tr><th><spring:message code='lbl.holidayPeriod'/></th><th><spring:message code='lbl.holidayDescription'/></th></tr>";
				var arrayJson = [];
				arrayJson = json[key];
				$.each(arrayJson,function(k,v){
					html +="<tr id="+arrayJson[k].holidayId+"><td >"+$.fullCalendar.formatDate(new Date(arrayJson[k].startDate),'yyyy-MM-dd') +" ~ "+ $.fullCalendar.formatDate(new Date(arrayJson[k].endDate),'yyyy-MM-dd')+"</td><td>"+arrayJson[k].holidayTitle+"</td></tr>";
				});
				html +='</table></div>';
				html +='</div>';
			});
			html += "<div id='add'></div>";
			$('#tab').removeClass('hide');
			$('#tab').html(html);
			$('#tab').tabs({ 
					selected: tabSelection
			});
		}
		
		$( "#tab" ).bind( "tabsselect", function(event, ui) { 
			tabSelection = ui.index;
		});
		
		
		$('#tab').delegate('table tbody tr','click',function(e){
			var calEvent = new Object();
			eventId = $(this).attr('id');
			if(eventId != undefined){
				$(".bubblemain").dialog("close");
				var trThis = $(this);
				trThis.toggleClass('hilight');
				split = trThis.find('td:first').html().split("~");
				holidayText = trThis.find('td:nth-child(2)').html().trim();
				$( ".bubblemain" ).dialog({
					position: {
						 my: "bottom",
						 of: e,
						 collision: "fix"
					 },
					 open: function() {
						 $('.edit,.delete').removeClass('hide');
						 $('.save').addClass('hide');
			    		 $('#startDate').val(split[0].trim());
			    		 $('#endDate').val(split[1].trim());
			    		 $('.value').val(holidayText);
			    		 $(".dateText").datepicker("enable");
			    		 $(".edit").unbind().bind('click',function(e){
			    			 e.preventDefault();
			    			 calEvent.id = eventId;
			    			 calEvent.title = $('.value').val();
			    			 calEvent.start = $.fullCalendar.parseISO8601($('#startDate').val()); 
			    			 calEvent.end = $.fullCalendar.parseISO8601($('#endDate').val());
			    			 updateCalender(calEvent);
			    			 $(".bubblemain").dialog("close");
			    			 trThis.removeClass('hilight');
				    		 $('.fc-button-agendaWeek').click(); 
			    		 });
			    		
			    		 $(".delete").unbind().bind('click',function(e){
			    			 e.preventDefault();
			    			 calEvent.id = eventId;
			    			 deleteCalender(calEvent);
			    			 trThis.removeClass('hilight');
			    			 $(".bubblemain").dialog("close");
			    			 $(".edit").unbind();
			    			 tabSelection = 0;
			    			 $('.fc-button-agendaWeek').click();
			    		 })
					 },
					 close: function(){
						 $(".dateText").datepicker("disable");
						 trThis.removeClass('hilight');
					 }
				});
				$(".bubblemain").dialog("open");
			}
		});
		
		$('#tab').delegate('#tabAdd','click',function(){
			 var value = parseInt($("div#tab ul li").eq(-2).text()) + 1;
// 			 $("<li class='ui-state-default ui-corner-top ui-tabs-selected'><a href='#" + value + "'>" + value + "</a></li>").insertBefore($(this).parent());
// 			 $("div#tab").append("<div id='" + value + "'></div>");
			 $('.popupDialog').text("<spring:message code='lbl.copy.startText'/>"+ value +"<spring:message code='lbl.copy.endText'/>");
			 $('.popupDialog').dialog("open");
		});	
		
		$('#tab').delegate('span.ui-icon-close','click',function(){
			var id = $( this ).closest("li").attr('key');
			var panelId = $( this ).closest( "li" ).remove().attr( "aria-controls" );
		    $( "#" + panelId ).remove();
		    $.ajax({
		    	type: 'post',
				url : "<c:url value='/calender/removeDataYear.html'/>",
				data : 'years=' + id,
				success : function(json){
					if(json){
						console.log('success');
						tabSelection = 0;
					    $('.fc-button-agendaWeek').click();
					}
					else{
						console.log('ERROR');
					}
				}
		    });
		    
		});	
		
	});
	
</script>
<div class="opr">
	<fieldset>
		<legend><spring:message code="holiday.calender"/></legend>
		<div id='calendar' class="fc fc-ltr"></div>
		<div id='calendarList' class='hide'></div>
	</fieldset>
</div>


<div class="bubblemain">
<form>
		<div class="popup">
			<h1><spring:message code="lbl.holiday"/></h1>
			<div class="popup_content">
			<p><label><spring:message code="lbl.startdate"/></label><span ><input type="text" readonly="readonly" name="startDate" id="startDate" class="textfield dateText" style="" /></span></p>
			<p><label><spring:message code="lbl.enddate"/></label><span ><input type="text" readonly="readonly" name="endDate" id="endDate" class="textfield dateText" style="" /></span></p>
			<p><label><spring:message code="lbl.holiday_descripition"/></label><input type="text" class='value'></p>
			<button type="button" class='save'><spring:message code="button.createEvent"/></button>
			<button type="button" class='delete'><spring:message code="button.delete"/></button>
			<button type="button" class='edit'><spring:message code="button.update"/></button>
			</div>
		</div>
		<!-- <div id="prong:f" class="bottom-prong" style="left: 182px;">
			<div class="prong-dk"></div>
			<div class="prong-lt"></div>
		</div>	 -->
</form>
</div>
<div id='tab' class='hide'>
</div>
<div class="popupDialog">
	<p> Do you want to copy Holiday from the Previous to New Year? </p>
</div>

