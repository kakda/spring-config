<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<c:url value="/time-cards/reports/download-billable.html" var="downloadUrl"/>
<c:url value="/reports/download/token.html" var="downloadTokenUrl"/>
<c:url value="/reports/download/progress.html" var="downloadProgressUrl"/>

<script type="text/javascript">
	$(document).ready(function(){
		$("#frmFilter").validationEngine();
		$("#btnPreview").click(function(event){
			event.preventDefault(); 
			var isValidate = $("#frmFilter").validationEngine('validate');
			if(isValidate){
				renderNewGrid();
				// Do something
			}
		});
		
		$( "#startDate" ).datepicker({
			onSelect: function() {
				var minDate = $(this).datepicker('getDate');
				minDate.add(1).days();
				$( "#endDate" ).datepicker( "option", "minDate", minDate);
			}
		}).unbind('blur');
		$( "#endDate" ).datepicker({
			onSelect: function(selectedDate) {
				var maxDate = $(this).datepicker('getDate');
				maxDate.add(-1).days();
				$( "#endDate" ).datepicker( "option", "maxDate", maxDate);
			}
		}).unbind('blur');
		
	});

	function getBillable(){
		return $("#billed").is(":checked") ? "true" : "false";
	}
	
	function renderNewGrid(){
		$("#timeCardList").GridUnload();
		$("#timeCardList").jqGrid({
	        url: "<c:url value='/time-cards/reportTimeCardByBillableAjax.html'/>",
	        datatype: "json",
	        mtype: "GET",
	        colNames: ["<spring:message code='th.time_card.project' />", "<spring:message code='lbl.time_card.date' />", "<spring:message code='lbl.time_card.working_hour' />"],
	        colModel: [
				{
				    "name":"projectName",
				    "summaryTpl":"{0}",
				    "index":"projectName",
				    "sortable":false
				},
	             {
	                 "name":"tDate",
	                 "summaryTpl": "<div style='text-align: right'><spring:message code='th.time_card.sum' />: </div>",
	                 "index":"tDate",
					 "sortable":false,
	     			 "align": "center",
	                 "summaryType": "count"
	             },
	             {
	                 "name":"workingHour",
	                 "summaryTpl":"{0} ",
	                 "index":"workingHour",
	                 "formatter": "number",
	                 "summaryType":"sum",
	     			 "align": "right",
					 "sortable":false
	             }
	        ],
	        postData: {
	        	startDate: function(){
					return $("#startDate").val(); 
				},
	        	endDate: function(){
					return $("#endDate").val(); 
				},
				billable: function(){
					return getBillable();
				}
	        },
			rowNum : 99999,
	        hoverrows: false,
	        viewrecords: true,
			sortable: false,
	        caption: "",
	        height: "100%",
	        emptyrecords: "Empty records",
	        loadonce: false,
	        rownumbers: true,
	        pager: "#timeCardPage",
	        scrollrows: false,
			autowidth : true,
	        loadComplete: function () {},
			footerrow : true, 
			rowList: [],        	// disable page size dropdown
		    pgbuttons: false,     	// disable page control like next, back button
		    pgtext: null,         	// disable pager text like 'Page 0 of 10'
		    viewrecords: false,
	        jsonReader: {
	            page: "page",
	            total: "total",
	            records: "records",
	            root: "rows",
	            repeatitems: false
	        },
	        gridComplete: function () {
	        	var sum = $("#timeCardList").jqGrid('getCol','workingHour',false,'sum');
	        	$("#timeCardList").jqGrid('footerData','set',{tDate:"<div style='text-align: right'><spring:message code='th.time_card.total_hour' />:</div>",workingHour:sum});
	        },
	        grouping:true,
	        groupingView: {
	            groupField: ["projectName"],
	            groupColumnShow: [false, false],
	            groupText: ["<spring:message code='th.time_card.project' />: \u003cb\u003e{0}\u003c/b\u003e - {1} <spring:message code='th.time_card.row' />(s)"],
	            groupOrder: ["asc"],
	            groupSummary: [true],
	            groupCollapse: false,
	            groupDataSorted: false,
	            showSummaryOnHide: [false],
	        } 
	    });
		$("#timeCardList").jqGrid('navGrid', '#timeCardPage', {
			edit : false,
			add : false,
			del : false,
			search : false,
			refresh: false
		});
		$("#timeCardList").navButtonAdd('#timeCardPage',
			{ 	caption:"PDF", 
				buttonicon:"ui-icon-circle-arrow-s", 
				onClickButton: function(){
					download('pdf');
				},
				position: "last", 
				title:"", 
				cursor: "pointer"
			} 
		);
		
		$("#timeCardList").navButtonAdd('#timeCardPage',
			{ 	caption:"Excel", 
				buttonicon:"ui-icon-circle-arrow-s", 
				onClickButton: function(){
					download('xls');
				},
				position: "last", 
				title:"", 
				cursor: "pointer"
			} 
		);
	}
	function download(type) {
		// Retrieve download token
		// When token is received, proceed with download
// 		$.get('${downloadTokenUrl}', function(response) {
// 			// Store token
// 			var token = response.message[0];
			
// 			// Show progress dialog
// 			$(".message-centered").html("<spring:message code='message.downloading_data' />");
//             $(".message-centered").show();			
									
// 			window.location = '${downloadUrl}'+'?token='+token+'&startDate='+$("#startDate").val()+"&endDate="+$("#endDate").val()+"&billable="+getBillable()+"&type="+type;

// 			var frequency = 1000;
// 			var timer = setInterval(function() {
// 				$.get('${downloadProgressUrl}', {token: token}, 
// 						function(response) {
// 							// If token is not returned, download has started
// 							// Close progress dialog if started
// 							if (response.message[0] != token) {
// 								$(".message-centered").hide();
// 								clearInterval(timer);
// 							}
// 					});
// 			}, frequency);
			
// 		});
		if(type=='xls'){
			$('#frmFilter').attr('action',"<c:url value='/time-cards/reportTimeCardByBillableExcel.html'/>");
			$('#frmFilter').submit();
		}else if(type=='pdf'){
			$('#frmFilter').attr('action',"<c:url value='/time-cards/reportTimeCardByBillablePdf.html'/>");
			$('#frmFilter').submit();
		}
	}
</script>
<div class="adminform">
	<div class="title"><spring:message code="legend.time_card.by_billable" /></div>
	<div class="opr">		
		<form action="" id="frmFilter" class="form" >
			<fieldset>
				<legend><spring:message code="lbl.filter"/></legend>
				<table class="form" cellspacing="0" cellpadding="0">
					<tr>
						<td>
						    <label for="startDate"><spring:message code='lbl.time_card.start_date' /></label>
						</td>
						<td style="width: 250px;" class='input'>
							<input type="text" readonly="readonly" name="startDate" id="startDate" class="textfield validate[required,custom[date]]" />
						</td>
						<td>
						    <label for="endDate"><spring:message code='lbl.time_card.end_date' /></label>
						</td>
						<td style="width: 250px;" class='input'>
							<input type="text" readonly="readonly" name="endDate" id="endDate" class="textfield validate[required,custom[date]]" />
						</td>
						<td>
							<input type="checkbox"  id="billed" name="billable" />
						</td>
						<td>
						    <label for="billed"><spring:message code="th.billable" /></label>
						</td>
						<td>
							<button id="btnPreview" class="search" style="margin-left:30px;"><spring:message code="button.preview" /></button>
						</td>
					</tr>
				</table>
			</fieldset>
		</form>
		<form class="form" action="">
			<fieldset>
				<legend><spring:message code="legend.time_card.by_billable" /></legend>
				<div>
					<table id="timeCardList"></table>
					<div id="timeCardPage"></div>
				</div>
			</fieldset>
		</form>
	</div>
</div>
<div class="clr"></div>