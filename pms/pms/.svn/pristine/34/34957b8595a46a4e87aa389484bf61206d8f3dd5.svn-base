<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<script type="text/javascript">
	$(document).ready(function(){
		var dateFormat = "yyyy-MM-dd";
		var chart;
		var existingChart = [];


		var w2date = function(year, wn, dayNb){
		    var j10 = new Date( year,0,10,12,0,0),
		        j4 = new Date( year,0,4,12,0,0),
		        mon1 = j4.getTime() - j10.getDay() * 86400000;
		    return new Date(mon1 + ((wn - 1)  * 7  + dayNb) * 86400000).add(-1).days();
		};
		
		var short2LongDate = function(date){
			switch (date.substr(0,3).toLowerCase()){
				case 'mon':
					return "monday"; break;
				case 'tue':
					return "tuesday"; break;
				case 'wed':
					return "wednesday"; break;
				case 'thu':
					return "thursday"; break;
				case 'fri':
					return "friday"; break;
				case 'sat':
					return "saturday"; break;
				case 'sun':
					return "sunday"; break;
			}
		}
		
		
        var options = {
            chart: {
                renderTo: 'chartReport',
                marginRight: 130,
                marginBottom: 25,
                type: 'spline',
                events: {
                	click: null
                }
            },
            point: {
            },
            colors: [
                   	'#039000', 
                	'#AA4643', 
                	'#89A54E', 
                	'#80699B', 
                	'#3D96AE', 
                	'#DB843D', 
                	'#92A8CD', 
                	'#A47D7C', 
                	'#B5CA92'
                ]
            ,
            title: {
                text: 'Employee Working Hour',
                x: -20 //center
            },
            subtitle: {
                text: '',
                x: -20
            },
            xAxis: {
                min: 0,      
                labels: {
                    enabled: false
                },
                categories: []
            },
            yAxis: {
            	min: 0,
                title: {
                    text: "<spring:message code='lbl.time_card.working_hour' />"
                },
                plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
            },
            tooltip: {
                formatter: function() {                	
                    return '<b>'+ this.y +' Hour</b><br/>'+ this.x.substr(this.x.lastIndexOf('/')+1, this.x.length);
                }
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: 0,
                y: 40,
                borderWidth: 1,
                backgroundColor: 'white'
            },
            plotOptions: {
            	spline: {
    				lineWidth: 1,
    				states: {
    					hover: {
    						lineWidth: 5
    					}
    				},
    				marker: {
    					enabled: false,
    					states: {
    						hover: {
    							enabled: true,
    							symbol: 'circle',
    							radius: 5,
    							lineWidth: 1
    						}
    					}
    				}
    			},
				series: {
					cursor: 'pointer',
				    point: {
				    	events: {
				    		click: function(event) {
								var year = this.category.substr(0,4),
									week = this.category.substr(4,this.category.indexOf('/')-4),
									day = short2LongDate(this.category.substr(this.category.indexOf('/')+1,3)), 
									serieName = this.category.substr(this.category.lastIndexOf('/')+1, this.category.length),
									employeeID = $("#employeeID").val(),
									tDate = this.category.substr(this.category.indexOf(', ')+2, 15);

					        	$.ajax({
					          		  url: "<c:url value='/time-cards/reportGetEmployeeFilterByDayAjax.html' />",
					          		  type: "GET",
					          		  data: "tDate="+tDate+"&employeeID="+employeeID,
					          		  dataType: "json",
					 				  async : false,
					          		  success: function(response){
					          				options.series = [];
					          				var series = {};
					          				series.data = [];
					          	        	options.xAxis.categories = [];
					          	 			options.xAxis.labels.enabled= true;
					          	 			options.chart.type = 'column';
					          	 			
					       	   				series.name =  serieName;
					            			$.each(response, function(key, value){
					            				//console.log(key);
					            				//console.log(value);
					            				//series.data.push(setSeriesDailyFilter(key, value, day));
					            				series.data.push(value.totalWorkingHour);
					            				options.xAxis.categories.push(value.projectName);
					            			});
				          				    options.series.push(series);
				            	 			options.title.text = $("#employeeID option:selected").text();
				            	 			options.subtitle.text = serieName; 
				            	 			options.chart.events.click = function(){
				            	 				previewReport();
				            	 			}
				            	 			chart = new Highcharts.Chart(options);
					          		  }
					        	});
				    		}
    					}
    				}
					/* alert(event.xAxis[0].value); */
                }
            },
            series: []
        };
                
        var setSeriesDailyFilter = function(key, value, day){
        	var val = 0;
			switch (day){
				case "monday":
					if(value.monday > 0){
						val = value.monday;	
					}
					break;
				case "tuesday":
					if(value.tuesday > 0){
						val = value.tuesday;
					}
					break;
				case "wednesday":
					if(value.wednesday > 0){
						val = value.wednesday;
					}
					break;
				case "thursday":
					if(value.thursday > 0){
						val = value.thursday;
					}
					break;
				case "friday":
					if(value.friday > 0){
						val = value.friday;
					}
					break;
				case "saturday":
					if(value.saturday > 0){
						val = value.saturday;
					}
					break;
				case "sunday":
					if(value.sunday > 0){
						val = value.sunday;
					}
					break;
			}
			options.xAxis.categories.push(value.projectName);
        	return val;
        }
        
		$("#filter").validationEngine();

        $("#startDate").datepicker({
            numberOfMonths: 2,
            maxDate: 0,
            onSelect: function(selected) {
				var startDate = $(this).datepicker("getDate");
                $("#endDate").datepicker("option","minDate", startDate.add(1).days())
            }
        }).unbind('blur');
        
        $("#endDate").datepicker({
            numberOfMonths: 2,
            maxDate: 0,
            onSelect: function(selected) {
				var endDate = $(this).datepicker("getDate");
                $("#startDate").datepicker("option","maxDate", endDate.add(-1).days())
            }
        }).unbind('blur');
        
       
        $("#btnPreview").click(function(event){
        	event.preventDefault();
        	var validate = $("#filter").validationEngine("validate");
        	if(validate){
    			previewReport();	
        	}
        });
        
        var previewReport = function(){
 			options.series = []; 	
 			options.chart.events.click = null;
 			options.xAxis.categories = [];
 			options.xAxis.labels.enabled= false;
	 		options.chart.type = 'spline';
	 			
 	        var formFilter= $("#filter").serialize();
        	$.ajax({
          		  url: "<c:url value='/time-cards/reportGetEmployeePeriodAjax.html' />",
          		  type: "GET",
          		  data: formFilter,
          		  dataType: "json",
 					  async : false,	          		  
          		  beforeSend: function () {
  					// Do something
          		  },
          		  success: function(response){
  					var series = {};
   				    series.name = $("#employeeID option:selected").text();
   				    series.data = [];
   				 	series.threshold = null;
   				 	series.fillColor = {
	                     linearGradient : {
	                         x1: 0,
	                         y1: 0,
	                         x2: 0,
	                         y2: 1
	                     },
	                     stops : [[0, Highcharts.getOptions().colors[0]], [1, 'rgba(0,0,0,0)']]
	                };
   				 	series.tooltip = {
   						valueDecimals: 7
   					}
   				    
          			$.each(response, function(key, value){
          				var tDate = new Date();
           				var str  = value.tDate.split("-");
          				tDate.setFullYear(str[0], str[1]-1, str[2]);
          				var data = tDate.toString("yyyy").toString() + tDate.getWeek().toString() + "/" + tDate.toString("ddd").toString() + ", " + tDate.toString(dateFormat).toString();   
          				options.xAxis.categories.push(data);      				
					    series.data.push(value.workingHour);
          			}); 
  				    options.series.push(series);
          		  }
          		  
          	});
 			options.title.text = $("#employeeID option:selected").text();
 			options.subtitle.text = $("#startDate").val() + " To " + $("#endDate").val(); 
 			chart = new Highcharts.Chart(options);
        }
	});
</script>
<div class="adminform">
	<div class="title"><spring:message code="legend.time_card.daily_report" /></div>
	<div class="opr">		
		<form action="" class="form" id="filter" >
			<fieldset>
				<legend><spring:message code="lbl.filter"/></legend>
				<table class="form" cellspacing="0" cellpadding="0">
					<tr>
						<td class="label" style="width: 120px;"><label for="employeeId"><spring:message code='lbl.time_card.employee'/></label><span
							class="required">*</span></td>
						<td class="input"><spring:message code='select.select_employee' var="select_employee"/><jsp:include
								page="/time-cards/selectEmployeeList.html?validate=required&id=employeeID&placeholder=${select_employee}"></jsp:include></td>
					</tr>
					<tr>
						<td class="label"><label for="weekDate"><spring:message code='lbl.time_card.start_date' /></label><span
							class="required">*</span></td>
						<td class="input"><input type="text" class="textfield validate[required]"
							name="startDate" readonly="readonly"  id="startDate" /></td>
						<td class="label"><label for="weekDate"><spring:message code='lbl.time_card.end_date' /></label><span
							class="required">*</span></td>
						<td class="input"><input type="text" class="textfield validate[required]"
							name="endDate" readonly="readonly"  id="endDate" /></td>
						<td class="input">
							<button id="btnPreview" class="search" style="margin-left:30px;"><spring:message code="button.preview" /></button>
						</td>
				</table>
			</fieldset>
		</form>
		<form class="form" action="">
			<fieldset>
				<legend>Chart</legend>
        		<div id="chartReport" style="width: 100%; height: 400px;"></div>
			</fieldset>
		</form>
	</div>
</div>
<div class="clr"></div>