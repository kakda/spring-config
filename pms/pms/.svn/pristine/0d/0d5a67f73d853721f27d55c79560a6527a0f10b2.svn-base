<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<c:url value="/employees/reports/download.html" var="downloadUrl"/>
<c:url value="/reports/download/token.html" var="downloadTokenUrl"/>
<c:url value="/reports/download/progress.html" var="downloadProgressUrl"/>

<script type="text/javascript">
	var autoSearch;
	$(window).load(function(){
		autoSearch = $("#autoSearch").attr('checked') ? true : false;
	});
	$(document).ready(function() {
		$("#employeeList").jqGrid(
						{
							url : "<c:url value='/employees/ajaxReportGrid.html'/>",
							datatype : 'json',
							mtype : 'GET',
							colNames : [ /* 'Action', */ '<spring:message code="th.id"/>',
									'<spring:message code="th.employee_name"/>', '<spring:message code="th.company_name"/>' , '<spring:message code="th.title"/>', '<spring:message code="th.grade"/>', '<spring:message code="th.join_date"/>', '<spring:message code="th.quit_date"/>', '<spring:message code="th.email"/>', '<spring:message code="lbl.mobile_phone"/>'],
							colModel : [/*  {
								name : 'act',
								index : 'act',
								width : 25,
								sortable : false,
								search: false
							},  */{
								name : 'employeeID',
								index : 'employeeID',
								width : 6
							}, 
							{
								name : 'employeeName',
								index : 'employeeName',
								width : 20
							}, {
								name : 'companyName',
								index : 'companyName',
								width : 25
							}, {
								name : 'titleName',
								index : 'titleName',
								width : 10
							}
							, {
								name : 'grade',
								index : 'grade',
								width : 5
							}
							, {
								name : 'joinDate',
								index : 'joinDate',
								width : 5
							}, {
								name : 'quitDate',
								index : 'quiteDate',
								width : 5
							}
							,{
								name : 'email',
								index : 'email',
								width : 15
							}
							,{
								name : 'mobilePhone',
								index : 'mobilePhone',
								width : 9
							}],
							postData : {},
							rowNum : 10,
							rowList : [ 10, 20, 40, 60, 100 ],
							height : 200,
							autowidth : true,
							rownumbers : true,
							pager : '#employeePage',
							sortname : 'employeeID',
							viewrecords : true,
							sortorder : "asc",
							caption : "",
							emptyrecords : "Empty records",
							loadonce : false,
							multiselect : false,
							height: 230,
							
							grouping: true, 
							groupingView : { 
								groupField : ['employeeName'],
								//groupColumnShow : [false],
								groupCollapse : true,
								groupDataSorted : true 
							},
							
							loadComplete : function() {
							},
							jsonReader : {
								page : "page",
								total : "total",
								records : "records",
								root : "rows",
								repeatitems : false
							},
							gridComplete : function() {
					            gridAction("#employeeList", "<c:url value='/employees/' />", "employeeID", false, false, false)
					            $('input[name*="jqg_employeeList"]').hide();
					    		$('input[id=cb_employeeList]').hide();
							}
						});
		$("#employeeList").jqGrid('navGrid', '#employeePage', {
			edit : false,
			add : false,
			del : false,
			search : false
		}, {}, {}, {}, { // search
			sopt : [ 'cn', 'eq' ],
			closeOnEscape : true,
			multipleSearch : false,
			closeAfterSearch : true,
			position: "center"
		});
		
		$("#employeeList").navButtonAdd('#employeePage', {
			caption : "<spring:message code='button.pdf'/>",
			buttonicon : "ui-icon-circle-arrow-s",
			onClickButton : function() {
				download('pdf');
			},
			position : "last",
			title : "",
			cursor : "pointer"
		});

		$("#employeeList").navButtonAdd('#employeePage', {
			caption : "<spring:message code='button.excel'/>",
			buttonicon : "ui-icon-circle-arrow-s",
			onClickButton : function() {
				download('xls');
			},
			position : "last",
			title : "",
			cursor : "pointer"
		});

		$("#btnSearch").click(function(event) {
			event.preventDefault();
			gridReload();
		});
		/* $("#projectID").change(function() {
			if (autoSearch) {
				setTimeout(gridReload, 500);
			}
		});
		$("#year").change(function() {
			if (autoSearch) {
				setTimeout(gridReload, 500);
			}
		});
		$("#skillID").change(function() {
			if (autoSearch) {
				setTimeout(gridReload, 500);
			}
		});
		$("#autoSearch").change(function() {
			autoSearch = $(this).attr('checked');
		}); */
	});
	function gridReload() {	
		var projectID = $("#projectID").val();
		var year = $("#year").val();
		var skills = "";
		$("#skillID :selected").sort().each(function(){
			skills += ((skills!="")?",":"") + $(this).val();
		});
		$("#employeeList").jqGrid('setGridParam', {
			url : "<c:url value='/employees/ajaxReportGrid.html'/>",
			page : 1,
			mtype : "GET",
			search : true,
			postData : {
				searchOper : function() {
					return "cn";
				},
				searchString : function(){
					return projectID;
				},
				searchString1 : function(){
					return year;
				},
				searchString2 : function(){
					return skills;
				}
			}
		}).trigger("reloadGrid");
	}
	
	function download(type) {
		// Retrieve download token
		// When token is received, proceed with download
// 		$.get('${downloadTokenUrl}', function(response) {
// 			// Store token
// 			var token = response.message[0];
			
// 			// Show progress dialog
// 			$(".message-centered").html("<spring:message code='message.downloading_data'/>");
//             $(".message-centered").show();
			
//             var year = document.getElementById('year').value;

// 			var projectID = $("#projectID :selected").val();
			var projectName = $('#projectID :selected').text();
			
// 			var skillIDs = "";
			var skillNames = "";
			$("#skillID :selected").each(function(){
				skillNames += ((skillNames!="")?",":"") + $(this).text();
			});
			$("#skillName").val(skillNames);
			$("#projectName").val(projectName);
// 			$("#skillID :selected").sort().each(function(){
// 				skillIDs += ((skillIDs!="")?",":"") + $(this).val();
// 			});
			
// 			projectName = encodeURIComponent(projectName);
// 			skillNames = encodeURIComponent(skillNames);
			
// 			window.location = '${downloadUrl}'+'?token='+token+'&type='+type+'&p='+projectID+'&y='+year+'&s='+skillIDs+'&pn='+projectName+'&sn='+skillNames;

// 			// Check periodically if download has started
// 			var frequency = 1000;
// 			var timer = setInterval(function() {
// 				$.get('${downloadProgressUrl}', {token: token}, 
// 						function(response) {
// 							// If token is not returned, download has started
// 							// Close progress dialog if started
// 							if (response.message[0] != token) {
// 								$(".message-centered").hide();
// 								clearInterval(timer);
// 							}
// 					});
// 			}, frequency);
			
// 		});
		
		if(type == 'xls'){
// 			var projectID = $("#projectID :selected").val();
// 			var projectName = $('#projectID :selected').text();
			
// 			var skillIDs = "";
// 			$("#skillID :selected").sort().each(function(){
// 				skillIDs += ((skillIDs!="")?",":"") + $(this).val();
// 			});
// 			$('#skillIDs').val(skillIDs);
			$('#frmFilter').attr('action',"<c:url value='/employees/reports/downloadEmployeeExcel.html'/>");
			$('#frmFilter').submit();
		}else if(type =='pdf'){
			$('#frmFilter').attr('action',"<c:url value='/employees/reports/downloadEmployeePdf.html'/>");
			$('#frmFilter').submit();
		}
	}
	
</script>
<div class="adminform">
	<div class="opr">
		
		<form id="frmFilter"  action="">
		<div class="title"><spring:message code='lbl.hr_report'/></div>
		<fieldset>
			<legend><spring:message code="lbl.filter"/></legend>
			<table class="form" >
				<tr>
					<td class="label"><label for="project"><spring:message code='lbl.project'/></label></td>
					<td>
						<spring:message code="select.select_project" var="select_project" />
						<jsp:include page="/projects/selectMultiProjectList.html?id=projectID&placeholder=${select_project}&width=220px"></jsp:include>
					</td>
					<td class="label"><label for="year"><spring:message code="lbl.year"/></label></td>
					<td>
						<spring:message code="select.select_year" var="select_year" />
						<jsp:include page="/employees/selectEmployeeYear.html?id=year&placeholder=${select_year}&width=150px"></jsp:include>
					</td>
					<td class="label"><label for="skill"><spring:message code="th.skill"/></label></td>
					<td>	
						<spring:message code="select.select_skills" var="select_skill" />
						<jsp:include page="/skills/selectSkillList.html?id=skillID&placeholder=${select_skill}&multiple=true&width=220px"></jsp:include>
						<input type='hidden' name="skillName" id="skillName"/>
						<input type="hidden" name="projectName" id="projectName"/>
					</td>
					
					<%-- <td>
						<input type="checkbox" id="autoSearch" />
					</td>
					<td>
						<label for="autoSearch"><spring:message code="lbl.auto"/></label>
					</td> --%>
					<td>
						<button id="btnSearch" class="search"><spring:message code="button.preview"/></button>
					</td>
				</tr>
			</table> 
		</fieldset>
		
		</form>
		<form action="">
			<fieldset>
				<legend><spring:message code='lbl.hr_list'/></legend>
				<div>
					<table id="employeeList"></table>
					<div id="employeePage"></div>
				</div>
			</fieldset>
		</form>
	</div>
</div>
<div class="clr"></div>