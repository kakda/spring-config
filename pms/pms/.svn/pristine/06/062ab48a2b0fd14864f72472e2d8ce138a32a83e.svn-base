<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<script type="text/javascript">
var gridActions = function (grid, prefixUrl, fieldId, isEdit, isView, isDelete,isReactive) {
    var d = jQuery(grid).jqGrid("getDataIDs");
    for (var e = 0; e < d.length; e++) {
    	//alert($.trim($(grid).getCell(d[e],'quitDate')) == '' ? "aaa" : "bbb" );
        var f = d[e];
        var row = "";
        if(isEdit)
            row += "<button class='btnEdit' value='" + f + "' >Edit</button>"; 
        if(isView)
        	row += "<button class='btnView' value='" + f + "' >View</button>";	
        if(isDelete)
        	row += "<button class='btnDelete' value='" + f + "' >Delete</button>";
        if(isReactive)
        {   if($.trim($(grid).getCell(d[e],'quitDate')) !== '') 
        	row += "<button class='btnReActive' value='" + f + "' >Re-Employ</button>";
        
        }
        jQuery(grid).jqGrid("setRowData", d[e], {
            act: row
        })
    if(isEdit){
        $(".btnEdit").button({
            text: false,
            icons: {
                primary: "ui-icon-pencil"
            }
        }).click(function (a) {
            a.preventDefault();
            var b = $(grid).jqGrid("getCell", $(this).val(), fieldId);
            window.location = prefixUrl+"update/" + b + ".html"
        });
    }
    if(isView){
        $(".btnView").button({
            text: false,
            icons: {
                primary: "ui-icon-newwin"
            }
        });
        $(".btnView").click(function (a) {
            a.preventDefault();
            var b = $(grid).jqGrid("getCell", $(this).val(), fieldId);
            window.location = prefixUrl+"view/" + b + ".html"
        });	
    }
    if(isDelete){
        $(".btnDelete").button({
            text: false,
            icons: {
                primary: "ui-icon-trash"
            }
        });
        $(".btnDelete").click(function (a) {
            a.preventDefault();
            var b = $(this).val();
            var c = $(grid).jqGrid("getCell", b, fieldId);
            //$("#dialog").html("Are you sure want to delete row [" + c + "] ?");
            $("#dialog").html("<spring:message code='message.delete_selected'/>");
            $("#dialog").dialog({
                resizable: false,
                height: 140,
                modal: true,
                title: "Warning",
                position: "center",
                buttons: {
                    OK: function () {
                        $.ajax({
                            url: prefixUrl + "doDelete/" + c + ".html",
                            type: "post",
                            beforeSend: function () {
                                $("#loading").slideToggle(100)
                            },
                            success: function (a) {
                            	$("#dialog").dialog("close");
                                if ($.trim(a) == "true") {
                                    $(grid).jqGrid("delRowData", b)
                                }else{
                                	$("#dialog").html("<spring:message code='message.delete_error'/>");
	                                $("#dialog").dialog({
	                                    resizable: false,
	                                    height: 140,
	                                    modal: true,
	                                    title: "Error",
	                                    position: "center",
	                                    buttons: {
	                                        OK: function () {
	                                            $(this).dialog("close")
	                                        }
	                                    }
	                                });
                                }
                                $("#loading").slideToggle(300);
                                
                            }
                        })
                    },
                    Cancel: function () {
                        $(this).dialog("close")
                    }
                }
            })
        })
    }
    if(isReactive)
   	{
    	$(".btnReActive").button({
            text: false,
            icons: {
                primary: "ui-icon-person"
            }
        }).click(function (a) {
            a.preventDefault();
            var b = $(grid).jqGrid("getCell", $(this).val(), fieldId);
            window.location = prefixUrl+"update/" + b + ".html?re_employ=true"
        });
   	}
}
}
	var autoSearch;
	$(window).load(function(){
		autoSearch = $("#autoSearch").attr('checked') ? true : false;
	});
	$(document).ready(function() {
		 $(".btnDeleteSelected").click(function(event){
			event.preventDefault();
		 	deleteSelctedRow("#contractorList", "<c:url value='/contractors/doDelete/' />", 'employeeID');
		 });
		 $(".addNew").click(function(event){
			event.preventDefault();
			window.location = "<c:url value='/contractors/add.html'/>";
		 });
		$("#contractorList").jqGrid(
						{
							url : "<c:url value='/contractors/ajaxGrid.html'/>",
							datatype : 'json',
							mtype : 'GET',
							colNames : [ '<spring:message code="th.action"/>', '<spring:message code="th.id"/>',
									'<spring:message code="th.contractor_name"/>', '<spring:message code="th.team"/>' , '<spring:message code="th.title"/>', '<spring:message code="th.role"/>','<spring:message code="th.join_date"/>','<spring:message code="th.quit_date"/>'],
							colModel : [ {
								name : 'act',
								index : 'act',
								width : 30,
								sortable : false,
								search: false
							}, {
								name : 'employeeID',
								index : 'employeeID',
								width : 20
							}, {
								name : 'employeeName',
								index : 'employeeName',
								width : 50
							}, {
								name : 'teamName',
								index : 'teamName',
								width : 50
							}
							, {
								name : 'titleName',
								index : 'titleName',
								width : 50
							}
							, {
								name : 'roleName',
								index : 'roleName',
								width : 50
							},
							{
								name : 'joinDate',
								index : 'joinDate',
								width : 30
							},
							{
								name : 'quitDate',
								index : 'quitDate',
								width : 30
							}],
							postData : {},
							rowNum : 10,
							rowList : [ 10, 20, 40, 60, 100 ],
							height : 200,
							autowidth : true,
							rownumbers : true,
							pager : '#contractorPage',
							sortname : 'employeeID',
							viewrecords : true,
							sortorder : "asc",
							caption : "",
							emptyrecords : "Empty records",
							loadonce : false,
							multiselect : true,
							height: 230,
							page : getPageNumber("pageNumber"),
							loadComplete : function() {
							},
							jsonReader : {
								page : "page",
								total : "total",
								records : "records",
								root : "rows",
								repeatitems : false
							},
							gridComplete : function() {
					            gridActions("#contractorList", "<c:url value='/contractors/' />", "employeeID", true, true, true,true)
					            
					            setCookie("pageNumber", $('#contractorList').getGridParam('page'));
							}
						});
		$("#contractorList").jqGrid('navGrid', '#contractorPage', {
			edit : false,
			add : false,
			del : false,
			search : true
		}, {}, {}, {}, { // search
			sopt : [ 'cn', 'eq' ],
			closeOnEscape : true,
			multipleSearch : false,
			closeAfterSearch : true,
			position: "center"
		});
		
		$("#btnSearch").click(function(event){
			event.preventDefault();	
			gridReload();
		});
		$("#fieldValue").keydown(function(){
			if(autoSearch){
				setTimeout(gridReload,500);	
			} 			
		});
		$("#fieldName").change(function(){
			if(autoSearch){
				setTimeout(gridReload,500);	
			}
		});
		$("#autoSearch").change(function(){
			autoSearch = $(this).attr('checked');
		});
	});
	function gridReload(){ 
		var fieldName =  $("#fieldName").val();
		var fieldValue =  $("#fieldValue").val();
		$("#contractorList").jqGrid('setGridParam',
		{
			url:"<c:url value='/contractors/ajaxGrid.html'/>",
			page:1,
			mtype: "GET",
			search: true,
			postData: {
				searchOper: function(){
					return "cn";
				},
				searchField: function(){
					return fieldName;
				},
				searchString: function(){
					return fieldValue;
				}
			}
		}).trigger("reloadGrid"); 
	} 
</script>
<div class="adminform">
	<div class="opr">
		
		<form action="">
		<div class="title"><spring:message code="lbl.contractor_management"/></div>
		<fieldset>
			<legend><spring:message code="lbl.filter"/></legend>
			<table class="form" >
				<tr>
					<td class="input">
						<input type="text" class="textfield" id="fieldValue" />
					</td>
					<td>
						<select id="fieldName" class="select-single" style="width: 200px">
							<option value="employeeID"><spring:message code="lbl.contractor"/> ID</option>
							<option value="employeeName" selected="selected"><spring:message code="th.contractor_name"/></option>
							<option value="teamName"><spring:message code="th.team"/></option>
							<option value="titleName"><spring:message code="th.title"/></option>
							<option value="roleName"><spring:message code="th.role"/></option>
						</select>
					</td>
					<td>
						<input type="checkbox" id="autoSearch" />
					</td>
					<td>
						<label for="autoSearch"><spring:message code="lbl.auto"/></label>
					</td>
					<td>
						<button id="btnSearch" class="search"><spring:message code="button.search"/></button>
					</td>
				</tr>
			</table> 
		</fieldset>
		</form>
		<form action="">
			<fieldset>
				<legend><spring:message code="lbl.contractor_list"/></legend>
				<div>
					<table id="contractorList"></table>
					<div id="contractorPage"></div>
					<div>
					<button class="btnDeleteSelected delete"><spring:message code="button.delete"/></button>
					<button class="addNew add"><spring:message code="button.add"/></button>
					</div>
				</div>
			</fieldset>
		</form>
	</div>
</div>
<div class="clr"></div>