<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<script type="text/javascript">
	var dateFormat = "yyyy-MM-dd";
	var isSubmitted = false;

	$(window).load(function(){
		var mon = new Date();
		$("#weekDate").datepicker('setDate', mon);
		mon.setDate(mon.getDate() + 1 - (mon.getDay() || 7));
		var colNames = generateDateRangColumn(mon);
		var colModels = getColumnModels();
        $(".save").attr("disabled", isSubmitted).button("option", "disabled", !isSubmitted );
		renderNewTimeCard("#timeCardList", "#timeCardPage", colNames, colModels, mon);
		$("#unsubmit").validationEngine('attach', {
			onValidationComplete: function(form, status){
				if (status) {
					unsubmitTimeCards("#timeCardList");
				} 
			}
		}).hide();
		$(".save").click(function(event){
			event.preventDefault();
			var validate = $("#unsubmit").validationEngine("validate");
			if(validate){
	            $("#dialog").html("<spring:message code='message.time_card.confirm_unsubmit'/>");
	            $("#dialog").dialog({
	                resizable: false,
	                height: 'auto',
	                modal: true,
	                title: "<spring:message code='dialog.title.warning'/>",
	                position: "center",
	                buttons: {
	                    "<spring:message code='dialog.button.ok'/>": function () {
	                    	$("#unsubmit").submit();
	                    	$(this).dialog("close");
	                    },
	                    "<spring:message code='dialog.button.cancel'/>": function(){
	                    	$(this).dialog("close");
	                    }
	                }
	            });
			}
		})
	});
	$(document).ready(function(){
		$("#weekDate").datepicker({
			maxDate: 0,
			setDate: new Date(),
			onSelect : function() {
				var mon = $(this).datepicker('getDate');
				mon.setDate(mon.getDate() + 1 - (mon.getDay() || 7));
				var colNames = generateDateRangColumn(mon);
				var colModels = getColumnModels();
				renderNewTimeCard("#timeCardList", "#timeCardPage", colNames, colModels, mon);
			}
		});

		$("#prev").click(function(event){
			event.preventDefault();
			var mon = $("#weekDate").datepicker('getDate');
			mon.setDate(mon.getDate() + 1 - (mon.getDay() || 7));
			movePrevWeek(mon);
		});
		$("#next").click(function(event){
			event.preventDefault();
			var mon = $("#weekDate").datepicker('getDate');
			mon.setDate(mon.getDate() + 1 - (mon.getDay() || 7));
			moveNextWeek(mon);
		});
		
		$("#employeeID").chosen().change(function(event) {
			var mon = $("#weekDate").datepicker('getDate');
			mon.setDate(mon.getDate() + 1 - (mon.getDay() || 7));
			var colNames = generateDateRangColumn(mon);
			var colModels = getColumnModels();
			renderNewTimeCard("#timeCardList", "#timeCardPage", colNames, colModels, mon);
		});
		
		disabledApprovedId();
	});
	
	function disabledApprovedId(){
		$("#approvedID").attr("disabled", true);
	}
	
	function unsubmitTimeCards(grid){
		var userdata = $(grid).jqGrid('getGridParam', 'userData');		
        var data = $("#unsubmit").serialize();
        data += "&timeCardID="+userdata.timeCardID;
        data += "&employeeID="+$("#employeeID").val();
		$.ajax({
			data : data,
			url : "<c:url value='/time-cards/unsubmitTimeCard.html' />",
			type : "post",
			dataType : "json",
			async : false,
			success : function(){
				$("#unsubmit").find("select, textarea").val("");
                $("#unsubmitReasonID, #approvedID").trigger("liszt:updated");
			}
		});
		var mon = $("#weekDate").datepicker('getDate');
		mon.setDate(mon.getDate() + 1 - (mon.getDay() || 7));
		var colNames = generateDateRangColumn(mon);
		var colModels = getColumnModels();
		renderNewTimeCard("#timeCardList", "#timeCardPage", colNames, colModels, mon);
		$(".message-information .message-valid span").html("<spring:message code='message.time_card.unsubmit' />");
		$(".message-information").show();
	}

	function movePrevWeek(mon){
		mon.add(-7).days();
		$("#weekDate").datepicker('setDate', mon);
		var colNames = generateDateRangColumn(mon);
		var colModels = getColumnModels();
		renderNewTimeCard("#timeCardList", "#timeCardPage", colNames, colModels, mon);
	}
	
	function moveNextWeek(mon){
		mon.add(7).days();
		var curDate = new Date();
		// curDate.last().monday();
		if(curDate >= mon){
			$("#weekDate").datepicker('setDate', mon);
			var colNames = generateDateRangColumn(mon);
			var colModels = getColumnModels();
			renderNewTimeCard("#timeCardList", "#timeCardPage", colNames, colModels, mon);
		}
	}
	
	function renderNewTimeCard(grid, page, colNames, colModels, mon) {
		if($.trim($("#employeeID").val()) !=  ""){
			var startDate = mon.add(-6).days().toString(dateFormat);
			var year = mon.getFullYear();
			var week = mon.getWeek();
			var endDate = mon.add(7).days().toString(dateFormat);
			$(".message-information").hide();
			$(grid).GridUnload();
			$(grid).jqGrid({
				url : "<c:url value='/time-cards/entryJqgrid.html' />",
				datatype : "json",
				mtype : "GET",
				colNames : colNames,
				colModel : colModels,
				postData : {
					startDate: startDate,
					endDate: endDate,
					year: year,
					week: week,  
					employeeID: $("#employeeID").val()
				},
				rowNum : 99999,
				autowidth : true,
				rownumbers : true,
				pager : "page",
				viewrecords : true,
				sortable: false,
				caption : false,
				emptyrecords : "Empty records",
				loadonce : false,
				height : 230,
				search : false, 
				footerrow : true, 
				userDataOnFooter : true, 
				onSelectRow: function(id){
	
				},
				loadComplete : function() {
	                var ids =$(grid).jqGrid('getDataIDs');
					var userdata = $(grid).jqGrid('getGridParam', 'userData');
	                isSubmitted = userdata.submitted;
	                $(".save").attr("disabled", !isSubmitted).button("option", "disabled", !isSubmitted);
	                if(!isSubmitted){
	        			$("#unsubmit").hide();
	                }else{
	                	$("#unsubmit").show();
	                }
				},
			    onSelectAll: function(aRowids,status) {
			    },
				jsonReader : {
					page : "page",
					total : "total",
					records : "records",
					root : "rows",
					repeatitems : false
				},
				gridComplete : function() {
					var d = $(grid).jqGrid("getDataIDs");
			        for (var e = 0; e < d.length; e++) {
			            var f = d[e], row = "", sumField = 0, monday = 0, tuesday = 0, wednesday = 0, thursday = 0, friday = 0, saturday = 0, sunday = 0;

			            // Add blank to the zero value of timecard
			            
						monday 		= $(grid).jqGrid("getCell", f, "monday").toNumber() == 0 ? '' : $(grid).jqGrid("getCell", f, "monday").toNumber();
						tuesday 	= $(grid).jqGrid("getCell", f, "tuesday").toNumber() == 0 ? '' : $(grid).jqGrid("getCell", f, "tuesday").toNumber();
						wednesday 	= $(grid).jqGrid("getCell", f, "wednesday").toNumber() == 0 ? '' : $(grid).jqGrid("getCell", f, "wednesday").toNumber();
						thursday 	= $(grid).jqGrid("getCell", f, "thursday").toNumber() == 0 ? '' : $(grid).jqGrid("getCell", f, "thursday").toNumber();
						friday 		= $(grid).jqGrid("getCell", f, "friday").toNumber() == 0 ? '' : $(grid).jqGrid("getCell", f, "friday").toNumber();
						saturday 	= $(grid).jqGrid("getCell", f, "saturday").toNumber() == 0 ? '' : $(grid).jqGrid("getCell", f, "saturday").toNumber();
						sunday 		= $(grid).jqGrid("getCell", f, "sunday").toNumber() == 0 ? '' : $(grid).jqGrid("getCell", f, "sunday").toNumber();
							
						// Calculate summary for each rows					
			            	
			            sumField += $(grid).jqGrid("getCell", f, "monday").toNumber();
			            sumField += $(grid).jqGrid("getCell", f, "tuesday").toNumber();
			            sumField += $(grid).jqGrid("getCell", f, "wednesday").toNumber();
			            sumField += $(grid).jqGrid("getCell", f, "thursday").toNumber();
			            sumField += $(grid).jqGrid("getCell", f, "friday").toNumber();
			            sumField += $(grid).jqGrid("getCell", f, "saturday").toNumber();
			            sumField += $(grid).jqGrid("getCell", f, "sunday").toNumber();
			            
			            $(grid).jqGrid("setRowData", f, {
			                monday : monday,
			                tuesday : tuesday,
			                wednesday : wednesday,
			                thursday : thursday,
			                friday : friday,
			                saturday : saturday,
			                sunday : sunday,
			                summaryField : sumField.toNumber()
			            });

	    				
			        }
			        $(grid).jqGrid('footerData','set', {summaryField: $(grid).jqGrid('getCol','summaryField',false,'sum')});
				}
			});
		}
	}

	function generateDateRangColumn(mon) {
		return [ 
	         "Time Card ID", "Default", 
	         "Submitted", "Project ID", 
	         "<spring:message code='th.time_card.project_name'/>",
	         "<spring:message code='lbl.time_card.total'/>",
	 		 "<spring:message code='th.time_card.mon'/>, " + mon.toString("dd-MM"),
	 		 "<spring:message code='th.time_card.tue'/>, " + mon.add(1).days().toString("dd-MM"),
	 		 "<spring:message code='th.time_card.wed'/>, " + mon.add(1).days().toString("dd-MM"),
	 		 "<spring:message code='th.time_card.thu'/>, " + mon.add(1).days().toString("dd-MM"),
	 		 "<spring:message code='th.time_card.fri'/>, " + mon.add(1).days().toString("dd-MM"),
	 		 "<spring:message code='th.time_card.sat'/>, " + mon.add(1).days().toString("dd-MM"),
	 		 "<spring:message code='th.time_card.sun'/>, " + mon.add(1).days().toString("dd-MM")
		];
	}
	
	function getColumnModels(){
		return [ {
			name : "timeCardID",
			index : "timeCardID",
			hidden: true, 
			editable: false
		}, {
			name : "isDefault",
			index : "isDefault",
			hidden: true, 
			editable: false
		}, {
			name : "submitted",
			index : "submitted",
			hidden: true, 
			editable: false
		}, {
			name : "projectID",
			index : "projectID",
			hidden: true, 
			editable: false
		}, {
			name : "projectName",
			index : "projectName",
			editable: false,
			sortable: false,
			width : 250
		}, {
			name : "summaryField",
			index : "summaryField",
			editable : false,
			sortable : false,
			width: 50,
			align: 'right'
		}, {
			name : "monday",
			index : "monday",
			align: "right",
			editable: true, 
			sortable: false,
			width : 50,
		}, {
			name : "tuesday",
			index : "tuesday",
			align: "right",
			editable: true,
			sortable: false,
			width : 50
		}, {
			name : "wednesday",
			index : "wednesday",
			align: "right",
			editable: true,
			sortable: false,
			width : 50
		}, {
			name : "thursday",
			index : "thursday",
			align: "right",
			editable: true,
			sortable: false,
			width : 50
		}, {
			name : "friday",
			index : "friday",
			align: "right",
			editable: true,
			sortable: false,
			width : 50
		}, {
			name : "saturday",
			index : "saturday",
			align: "right",
			editable: true,
			sortable: false,
			width : 50
		}, {
			name : "sunday",
			index : "sunday",
			align: "right",
			editable: true,
			sortable: false,
			width : 50
		}];	
	}
	
</script>
<div class="adminform">
	<div class="title"><spring:message code="legend.time_card.unsubmit"/></div>
	<div class="opr">
		<form action="" class="form" >
			<fieldset>
				<legend><spring:message code="lbl.filter"/></legend>
				<table class="form" cellspacing="0" cellpadding="0">
					<tr>
						<td class="label" style="width: 120px;"><label for="employeeId"><spring:message code='lbl.time_card.employee'/></label><span
							class="required">*</span></td>
						<td class="input"><spring:message code='select.select_employee' var="select_employee"/><jsp:include
								page="/time-cards/selectEmployeeList.html?validate=required&id=employeeID&placeholder=${select_employee}"></jsp:include></td>
					</tr>
					<tr>
						<td class="label"><label for="weekDate"><spring:message code='lbl.time_card.select_week'/></label><span
							class="required">*</span></td>
						<td class="input"><input type="text" class="textfield"
							name="weekDate" readonly="readonly"  id="weekDate" /></td>
						<td class="input"><button class="prev" name="prev" id="prev"><spring:message code="button.previous"/></button>
							<button class="next" name="next" id="next"><spring:message code="button.next"/></button></td>
					</tr>
				</table>
			</fieldset>
		</form>
		<form class="form" action="">
			<fieldset>
				<legend><spring:message code="legend.time_card"/></legend>
				<div>
					<table id="timeCardList"></table>
					<div id="timeCardPage"></div>
				</div>
			</fieldset>
		</form>
		<form class="form" method="post" id="unsubmit" action="">
			<fieldset>
				<legend><spring:message code='legend.time_card.remark' /></legend>
				<table class="form" cellspacing="0" cellpadding="0">
					<tr>
						<td class="label" style="width: 120px;"><label for="timeCardUnsubmitID"><spring:message code='lbl.time_card.reason' /></label><span
							class="blue required">*</span></td>
						<td class="input"><spring:message code='select.select_employee' var="select_reason"/><jsp:include
								page="/time-cards/selectReasonList.html?validate=groupRequired[customerName]&id=unsubmitReasonID&placeholder=${select_reason}"></jsp:include></td>
						<td class="label"><label for="approvedID"><spring:message code="lbl.time_card.approve" /></label><span
							class="required">*</span></td>
						<td class="input"><spring:message code='select.select_person' var="select_person" /><jsp:include
								page="/time-cards/selectEmployeeList.html?validate=required&id=approvedID&placeholder=${select_person}"></jsp:include></td>
					</tr>
					<tr>
						<td>
							<label for="otherReason"></label><span
							class="blue required">*</span>
						</td>
						<td colspan="2">
							<textarea class="otherReason textarea validate[groupRequired[customerName]]" style="width: 100%;" name="otherReason" id="textarea" ></textarea>
						</td>
					</tr>
					<tr>
						<td colspan="4" class="button">
							<button class="save" name="save" value="save"><spring:message code='button.un_submit'/></button>
						</td>
					</tr>
				</table>
			</fieldset>
		</form>
	</div>
</div>