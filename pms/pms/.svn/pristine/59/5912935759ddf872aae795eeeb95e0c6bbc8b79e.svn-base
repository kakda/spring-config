<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<script type="text/javascript">
function gridReload() {
    var a = $("#fieldName").val();
    var b = $("#fieldValue").val();
    $("#userList").jqGrid("setGridParam", {
        url: "<c:url value='/users/ajaxGrid.html'/>",
        page: 1,
        mtype: "GET",
        search: true,
        postData: {
            searchOper: function () {
                return "cn"
            },
            searchField: function () {
                return a
            },
            searchString: function () {
                return b
            }
        }
    }).trigger("reloadGrid")
}
	var autoSearch;
	$(window).load(function(){
		autoSearch = $("#autoSearch").attr('checked') ? true : false;
	});
	$(document).ready(function() {
		var addList = new Array();
		var removeList = new Array();
		var activeFormatter = function(cellVal,options,rowObject) {
			if(rowObject.employeeID=='EMP0001') return "";
 			return "<input class='act_checkedbox' value=" + rowObject.employeeID + (cellVal==true?" checked":" ") + " type='checkbox' />"
	    };
	    var gridAction = function (grid) {
	        var d = jQuery(grid).jqGrid("getDataIDs");
	        for (var e = 0; e < d.length; e++) {
	            var f = d[e];
	            var row = "";
	                row += "<button class='btnReset' value='" + f + "' >Reset Password</button>"; 
	                jQuery(grid).jqGrid("setRowData", d[e], {
	                    act: row
	                })
	        }
            $(".btnReset").button({
                text: false,
                icons: {
                    primary: "ui-icon-pencil"
                }
            }).click(function (a) {
                a.preventDefault();
                var b = $(grid).jqGrid("getCell", $(this).val(), "employeeID");
                window.location = "<c:url value='/users/reset-password/" + b + ".html'/>";
            });

		};
		$("#userList").jqGrid(
						{
							url : "<c:url value='/users/ajaxGrid.html'/>",
							datatype : 'json',
							mtype : 'GET',
							colNames : [ '<spring:message code="th.active"/>','<spring:message code="th.reset_password"/>', '<spring:message code="th.id"/>',
									'<spring:message code="lbl.username"/>',  '<spring:message code="th.role"/>'],
							colModel : [ {
								name : 'active',
								index : 'active',
								formatter:activeFormatter,
								width : 25,
								align : 'center',
								sortable:false
								
							}, {
								name : 'act',
								index : 'act',
								width : 40,
								align : 'center',
								sortable:false
							}, {
								name : 'employeeID',
								index : 'employeeID',
								width : 50
							}, {
								name : 'userName',
								index : 'username',
								width : 140
							},  {
								name : 'roleName',
								index : 'roleName',
								width : 200,
								search: false
							}],
							postData : {},
							rowNum : 10,
							rowList : [ 10, 20, 40, 60, 100 ],
							height : 200,
							autowidth : true,
							rownumbers : true,
							pager : '#userPage',
							sortname : 'employeeID',
							viewrecords : true,
							sortorder : "asc",
							caption : "",
							emptyrecords : "Empty records",
							loadonce : false,
							//multiselect : true,
							 multiboxonly:true,
							height: 230,
							loadComplete : function() {
								$('.act_checkedbox').click(function(){
									var pCode=$(this).attr("value");
									if($(this).is(":checked")){
										if(!removeList.remove(pCode))
											addList.add(pCode);
									}
									else{
										if(!addList.remove(pCode))
											removeList.add(pCode);
									}
									
								});
							},
							jsonReader : {
								page : "page",
								total : "total",
								records : "records",
								root : "rows",
								repeatitems : false
							},

							gridComplete: function () {
						            gridAction("#userList")
						        }
						});
		$("#userList").jqGrid('navGrid', '#userPage', {
			edit : false,
			add : false,
			del : false,
			search : true
		}, {}, {}, {}, { // search
			sopt : [ 'cn', 'eq' ],
			closeOnEscape : true,
			multipleSearch : false,
			closeAfterSearch : true,
			position: "center"
		});
		
		$("#btnSearch").click(function(event){
			event.preventDefault();	
			gridReload();
		});
		$("#fieldValue").keydown(function(){
			if(autoSearch){
				setTimeout(gridReload,500);	
			} 			
		});
		$("#fieldName").change(function(){
			if(autoSearch){
				setTimeout(gridReload,500);	
			}
		});
		$("#autoSearch").change(function(){
			autoSearch = $(this).attr('checked');
		});
		$(".btnSave").click(function(e){
			e.preventDefault();
			//alert(addList + "\n" + removeList);
			$("#activeList").val(addList);
			$("#inActiveList").val(removeList);
			$("#save").val($(this).attr("value"));
			$("#loading").slideToggle(100, function () {
                    $.ajax({
                        url: "<c:url value='/users/doSave.html'/>",
                        type: "post",
                        async: false,
                        data: $("#frmSave").serialize(),
                        success: function (b) {

                        }
                    })
                
                $("#loading").slideToggle(300)
            });
		});
	});
</script>
<div class="adminform">
	<div class="break-crumbs"></div>
	<div class="opr">
		<form action="">
		<fieldset>
			<legend><spring:message code="lbl.filter"/></legend>
			<table class="form" >
				<tr>
					<td class="input">
						<input type="text" class="textfield" id="fieldValue" />
					</td>
					<td>
						<select id="fieldName" class="select-single" style="width: 200px">
							<option value="employeeID"><spring:message code="th.id"/></option>
							<option value="username" selected="selected"><spring:message code="lbl.username"/></option>
							<option value="roleName"><spring:message code="th.role"/></option>
						</select>
					</td>
					<td>
						<input type="checkbox" id="autoSearch" />
					</td>
					<td>
						<label for="autoSearch"><spring:message code="lbl.auto"/></label>
					</td>
					<td>
						<button id="btnSearch" class="search" style="margin-left:30px;"><spring:message code="button.search"/></button>
					</td>
				</tr>
			</table> 
		</fieldset>
		</form>
		<form id="frmSave" action="">
			<fieldset>
				<legend><spring:message code="lbl.username"/></legend>
				<div>
					<table id="userList"></table>
					<div id="userPage"></div>
					<div>
					<input type="hidden" id="activeList" name="activeList"/>
					<input type="hidden" id="inActiveList" name="inActiveList"/>
					<button class="btnSave save" value="save"><spring:message code='button.save'/></button>
					
					</div>
				</div>
			</fieldset>
		</form>
	</div>
</div>
<div class="clr"></div>