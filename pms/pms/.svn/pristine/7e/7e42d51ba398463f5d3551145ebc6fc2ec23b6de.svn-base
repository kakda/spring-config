<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<c:url value="/contractors/reports/download.html" var="downloadUrl"/>
<c:url value="/reports/download/token.html" var="downloadTokenUrl"/>
<c:url value="/reports/download/progress.html" var="downloadProgressUrl"/>

<script type="text/javascript">
	var autoSearch;
	$(window).load(function(){
		autoSearch = $("#autoSearch").attr('checked') ? true : false;
	});
	$(document).ready(function() {
		 $(".btnDeleteSelected").click(function(event){
			event.preventDefault();
		 	deleteSelctedRow("#contractorList", "<c:url value='/contractors/doDelete/' />", 'employeeID');
		 });
		 $(".addNew").click(function(event){
			event.preventDefault();
			window.location = "<c:url value='/contractors/add.html'/>";
		 });
		$("#contractorList").jqGrid(
						{
							url : "<c:url value='/contractors/ajaxGrid.html'/>",
							datatype : 'json',
							mtype : 'GET',
							colNames : [ 'Action', 'ID',
									'Contractor Name', 'Team' , 'Title', 'Role'],
							colModel : [ {
								name : 'act',
								index : 'act',
								width : 25,
								sortable : false,
								search: false
							}, {
								name : 'employeeID',
								index : 'employeeID',
								width : 20
							}, {
								name : 'employeeName',
								index : 'employeeName',
								width : 50
							}, {
								name : 'teamName',
								index : 'teamName',
								width : 50
							}
							, {
								name : 'titleName',
								index : 'titleName',
								width : 50
							}
							, {
								name : 'roleName',
								index : 'roleName',
								width : 50
							}],
							postData : {},
							rowNum : 10,
							rowList : [ 10, 20, 40, 60, 100 ],
							height : 200,
							autowidth : true,
							rownumbers : true,
							pager : '#contractorPage',
							sortname : 'employeeID',
							viewrecords : true,
							sortorder : "asc",
							caption : "",
							emptyrecords : "Empty records",
							loadonce : false,
							multiselect : true,
							height: 230,
							loadComplete : function() {
							},
							jsonReader : {
								page : "page",
								total : "total",
								records : "records",
								root : "rows",
								repeatitems : false
							},
							gridComplete : function() {
					            gridAction("#contractorList", "<c:url value='/contractors/' />", "employeeID", true, true, true)
								
							}
						});
		$("#contractorList").jqGrid('navGrid', '#contractorPage', {
			edit : false,
			add : false,
			del : false,
			search : true
		}, {}, {}, {}, { // search
			sopt : [ 'cn', 'eq' ],
			closeOnEscape : true,
			multipleSearch : false,
			closeAfterSearch : true,
			position: "center"
		});
		
		$("#contractorList").navButtonAdd('#contractorPage', {
			caption : "PDF",
			buttonicon : "ui-icon-circle-arrow-s",
			onClickButton : function() {
				download('pdf');
			},
			position : "last",
			title : "",
			cursor : "pointer"
		});

		$("#contractorList").navButtonAdd('#contractorPage', {
			caption : "Excel",
			buttonicon : "ui-icon-circle-arrow-s",
			onClickButton : function() {
				download('xls');
			},
			position : "last",
			title : "",
			cursor : "pointer"
		});
		
		$("#btnSearch").click(function(event){
			event.preventDefault();	
			gridReload();
		});
		$("#fieldValue").keydown(function(){
			if(autoSearch){
				setTimeout(gridReload,500);	
			} 			
		});
		$("#fieldName").change(function(){
			if(autoSearch){
				setTimeout(gridReload,500);	
			}
		});
		$("#autoSearch").change(function(){
			autoSearch = $(this).attr('checked');
		});
	});
	function gridReload(){ 
		var fieldName =  $("#fieldName").val();
		var fieldValue =  $("#fieldValue").val();
		$("#contractorList").jqGrid('setGridParam',
		{
			url:"<c:url value='/contractors/ajaxGrid.html'/>",
			page:1,
			mtype: "GET",
			search: true,
			postData: {
				searchOper: function(){
					return "cn";
				},
				searchField: function(){
					return fieldName;
				},
				searchString: function(){
					return fieldValue;
				}
			}
		}).trigger("reloadGrid"); 
	} 
	
	function download(type) {
		// Retrieve download token
		// When token is received, proceed with download
		$.get('${downloadTokenUrl}', function(response) {
			// Store token
			var token = response.message[0];
			
			// Show progress dialog
			$(".message-centered").html("Saving Data");
            $(".message-centered").show();
			/* $('#msgbox').text('Processing download...');
			$('#msgbox').dialog( 
					{	title: 'Download',
						modal: true,
						buttons: null
					}); */
			
			// Start download
			var y = document.getElementById('year').value;

			var p = {};
			if($("#projectID :selected").val().replace(/^\s+|\s+$/g, "") != ""){
				p[$("#projectID :selected").val()] = $("#projectID :selected").text();
			}
			var jp = JSON.stringify(p);
			
			var s = {};
		    $("#skillID :selected").each(function(){
		    	s[$(this).val()] = $(this).text();
		    });
		    var js = JSON.stringify(s);
		    
		    
			window.location = '${downloadUrl}'+'?token='+token+'&type='+type+'&p='+jp+'&y='+y+'&s='+js;

			// Check periodically if download has started
			var frequency = 1000;
			var timer = setInterval(function() {
				$.get('${downloadProgressUrl}', {token: token}, 
						function(response) {
							// If token is not returned, download has started
							// Close progress dialog if started
							if (response.message[0] != token) {
								$(".message-centered").hide();
								//$('#msgbox').dialog('close');
								clearInterval(timer);
							}
					});
			}, frequency);
			
		});
	}
	
</script>
<div class="adminform">
	<div class="opr">
		
		<form action="">
		<div class="title">Contractor Management</div>
		<fieldset>
			<legend>Filter</legend>
			<table class="form" >
				<tr>
					<td class="input">
						<input type="text" class="textfield" id="fieldValue" />
					</td>
					<td>
						<select id="fieldName" class="select-single" style="width: 200px">
							<option value="employeeID">Contractor ID</option>
							<option value="employeeName" selected="selected">Contractor Name</option>
							<option value="teamName">Team</option>
							<option value="titleName">Title</option>
							<option value="roleName">Role</option>
						</select>
					</td>
					<td>
						<input type="checkbox" id="autoSearch" />
					</td>
					<td>
						<label for="autoSearch">Auto</label>
					</td>
					<td>
						<button id="btnSearch" class="search">Search</button>
					</td>
				</tr>
			</table> 
		</fieldset>
		
		<fieldset>
			<legend>Report Filter</legend>
			<table class="form" >
				<tr>
					<td class="label"><label for="project">Project</label></td>
					<td>
						<jsp:include page="/projects/selectMultiProjectList.html?id=projectID&placeholder=Select Project&width=250px"></jsp:include>
					</td>
					<td class="label"><label for="year">Year</label></td>
					<td><select id="year" name="year"
						class="select-single textfield date" style="width: 70px;"></select>
						<script type="text/javascript">
							for (i = new Date().getFullYear(); i > 1993; i--) {
								$('#year').append(
										$('<option />').val(i).html(i));
							}
						</script>
						<%-- <jsp:include page="/projects/projectYear.html"></jsp:include> --%>
					</td>
					<td class="label"><label for="skill">Skill</label></td>
					<td><jsp:include page="/skills/selectSkillList.html?id=skillID&placeholder=Select Skill&multiple=true&width=250px"></jsp:include>
					</td>
					<td>
						<input type="checkbox" id="autoSearch" />
					</td>
					<td>
						<label for="autoSearch">Auto</label>
					</td>
					<td>
						<button id="btnSearch" class="search">Search</button>
					</td>
				</tr>
			</table> 
		</fieldset>
		
		</form>
		<form action="">
			<fieldset>
				<legend>Contractors List</legend>
				<div>
					<table id="contractorList"></table>
					<div id="contractorPage"></div>
					<div>
					<button class="btnDeleteSelected delete">Delete Selected</button>
					<button class="addNew add">Add New Contractor</button>
					</div>
				</div>
			</fieldset>
		</form>
	</div>
</div>
<div class="clr"></div>