<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<c:url value="/time-cards/reports/download-project.html" var="downloadUrl"/>
<c:url value="/reports/download/token.html" var="downloadTokenUrl"/>
<c:url value="/reports/download/progress.html" var="downloadProgressUrl"/>

<script type="text/javascript">
	$(document).ready(function(){
		
		// Change project to get employee list
		$("#projectID").chosen().change(function() {			
			getEmployeeByProject();
		}).trigger('change');
		
		$("#btnPreview").click(function(event){
			event.preventDefault();
			$("#frmFilter").validationEngine();
			var isValidate = $("#frmFilter").validationEngine('validate');
			if(isValidate){
				renderNewGrid();				
			}
		});
	});
	
	function getEmployeeByProject(){
		var data = {
				"projectID" : function(){
					return $("#projectID").val(); 
				}			
		};
		$.ajax({
			type : 'GET',
			url : "<c:url value='/time-cards/reportTimeCardOfProjectAjax.html'/>",
			dataType : 'json',
			contentType : "application/json",
			data : data,			
			success : function(json) {				
				setDisplayEmployee(json);
			}
		});
	}
	function setDisplayEmployee(json){
		var listUser ="";	
		var jsonObjArr = new Array();
		for(var i=0;l=json.rows.length,i<l;i++){			
			// get a part of json to other json
 			item = {};
 			item ["employeeID"] = json.rows[i].employeeID;
 	        item ["employeeName"] = json.rows[i].employeeName;	
 	       jsonObjArr.push(item);
	       
 		}
		var dupes = {};
		var singles = new Array();
		
		$.each(jsonObjArr, function(i, el) {
		    if (!dupes[el.employeeName]&&!dupes[el.employeeID]) {
		        dupes[el.employeeName] = true;
		        singles.push(el);
		    }
		});
		listUser = '<option value="All">All</option>';
		$.each(singles,function(i, lists){			
			listUser+='<option value="'+lists.employeeID+'">'+lists.employeeName+'</option>';
		});
		$("#staffID").html(listUser); 
		$("#staffID").trigger("liszt:updated");
	}
	function renderNewGrid(){
		$("#timeCardList").GridUnload();	
		var requestURL="",endDate = "";
		var html = "";
    	var startDate = new Object;
		 requestURL ="<c:url value='/time-cards/reportTimeCardOfProjectAjaxByStaffID.html'/>";		
		$("#timeCardList").jqGrid({
	        url: requestURL,
	        datatype: "json",
	        mtype: "GET",
	        colNames: [
	                   "<spring:message code='th.time_card.project' />",      // Project
	                   "<spring:message code='th.time_card.employee' />",     // Employee
	                   "<spring:message code='th.time_card.time_card_id' />", // Time Card ID
	                   "<spring:message code='lbl.time_card.date' />", 		  // Date
	                   "<spring:message code='lbl.time_card.working_hour' />", // Working Hour
	                   "<spring:message code='lbl.time_card.actualstartdate' />" // Working Hour
	                   ],
	        colModel: [
				 {
				    "name":"projectName",
				    "summaryTpl":"{0}",
				    "index":"projectName",
				    "sortable":false,
				    "formatter": function(cellval, opts, rowObject, action){
				    	startDate = rowObject.actualStartDate;
				    	var fullDate = new Date();
				    	//Thu May 19 2011 17:25:38 GMT+1000 {}
				    	//convert month to 2 digits
				    	var twoDigitMonth = ((fullDate.getMonth().length+1) === 1)? (fullDate.getMonth()+1) : '0' + (fullDate.getMonth()+1);
				    	var currentDate = fullDate.getFullYear()+ "-" + twoDigitMonth + "-" + fullDate.getDate();
				    	var html= '';
				    	//2014-03-19
				    	endDate=(rowObject.actualEndDate==null)?currentDate:rowObject.actualEndDate;
				    	//rowObject.actualStartDate);
					    console.log(rowObject);
				    	if(startDate != undefined){
				    		html = cellval+"<span style='margin-left: 50px'>Actual Start Date: "+rowObject.actualStartDate.split(' ')[0]+" ~ Actual End Date: "+endDate+" </span>";
				    		tempHtml = html;
				    	} else{
				    		if(typeof(rowObject) == 'string'){
				    			html = tempHtml;
				    		}else{
					    		html = cellval+"<span style='margin-left: 50px'>Actual Start Date: "+" "+" ~ Actual End Date: "+" "+" </span>";
					    		tempHtml = html;
				    		}
				    	}
				    	/* else if(startDate==null){
				    		alert(startDate);
				    		startDate = "None";
			    			endDate= "None";
			    			html = cellval+"<span style='margin-left: 50px'>Actual Start Date: "+startDate+" ~ Actual End Date: "+endDate+" </span>";
				    	} */
				    	return html;
				    } 
				},
	             {
	                 "name":"employeeName",
	                 "summaryTpl":"{0}",
	                 "index":"employeeName",
					 "sortable":false
	             },
	             {
	                 "name":"timeCardID",
	                 "summaryTpl":"{0}",
	                 "index":"timeCardID",
	     			 "align": "center",
					 "sortable":false
	             },{
	                 "name":"tDate",
	                 "summaryTpl": "<div style='text-align: right'><spring:message code='th.time_card.sum' />: </div>",
	                 "index":"tDate",
	     			 "align": "center",
	                 "summaryType": "count",
					 "sortable":false
	             },{
	                 "name":"workingHour",
	                 "summaryTpl":"{0} ",
	                 "index":"workingHour",
	                 "formatter": "number",
	                 "summaryType":"sum",
	     			 "align": "right",
					 "sortable":false
	             },	         
	             {
	                 "name":"actualStartDate",
	                 "summaryTpl":"{0}",
	                 "index":"actualStartDate",
					 "sortable":false,
					 "hidden":true
	             },
	        ],	        
	        postData: {	        	
	        	 projectID: function(){
					return $("#projectID").val(); 
				},
				staffID: function(){
					return $("#staffID").val();
				}	
	        },
			rowNum : 99999,
	        hoverrows: false,
	        viewrecords: true,
			sortable: false,
	        caption: "",
	        height: "100%",
	        emptyrecords: "Empty records",
	        loadonce: false,
	        rownumbers: true,
	        pager: "#timeCardPage",
	        scrollrows: false,
			autowidth : true,
	        loadComplete: function () {},	    
			footerrow : true, 
			rowList: [],        	// disable page size dropdown
		    pgbuttons: false,     	// disable page control like next, back button
		    pgtext: null,         	// disable pager text like 'Page 0 of 10'
		    viewrecords: false,
	        jsonReader: {
	            page: "page",
	            total: "total",
	            records: "records",
	            root: "rows",
	            repeatitems: false
	        },
	        gridComplete: function () {
	        	var sum = $("#timeCardList").jqGrid('getCol','workingHour',false,'sum');	        
	        	$("#timeCardList").jqGrid('footerData','set',{tDate:"<div style='text-align: right'><spring:message code='th.time_card.total_hour' />:</div>",workingHour:sum});
	        },	        
	        grouping:true,
	        groupingView: {
	            groupField: ["projectName", "employeeName"],
	            groupColumnShow: [false, false],
	            groupText: [
	                        "<spring:message code='th.time_card.project' />: \u003cb\u003e{0}\u003c/b\u003e - {1} <spring:message code='th.time_card.row' />(s) ", 
	                        "<spring:message code='th.time_card.employee' />: \u003cb\u003e{0}\u003c/b\u003e " 
	                        ],
	            groupOrder: ["asc", "asc"],
	            groupSummary: [false, true],
	            groupCollapse: false,
	            groupDataSorted: false,
	            showSummaryOnHide: [false, false],
	        }
	        
	    });
		$("#timeCardList").jqGrid('navGrid', '#timeCardPage', {
			edit : false,
			add : false,
			del : false,
			search : false,
			refresh: false
		});
		$("#timeCardList").navButtonAdd('#timeCardPage',
			{ 	caption:"PDF", 
				buttonicon:"ui-icon-circle-arrow-s", 
				onClickButton: function(){
					download('pdf');
				},
				position: "last", 
				title:"", 
				cursor: "pointer"
			} 
		);
		
		$("#timeCardList").navButtonAdd('#timeCardPage',
			{ 	caption:"Excel", 
				buttonicon:"ui-icon-circle-arrow-s", 
				onClickButton: function(){
					download('xls');
				},
				position: "last", 
				title:"", 
				cursor: "pointer"
			} 
		);
		//call this function to write staff to filter
// 		getEmployeeByProject();
	}
	
	function download(type) {
		console.log('something type: '+type);
		// Retrieve download token
		// When token is received, proceed with download
		/* $.get('${downloadTokenUrl}', function(response) {
			// Store token
			var token = response.message[0];
			
			// Show progress dialog
			$(".message-centered").html("<spring:message code='message.downloading_data' />");
            $(".message-centered").show();
			

			var projectID = $("#projectID").val();
									
			window.location = '${downloadUrl}'+'?token='+token+'&projectID='+projectID+"&type="+type;

			var frequency = 1000;
			var timer = setInterval(function() {
				$.get('${downloadProgressUrl}', {token: token}, 
						function(response) {
							// If token is not returned, download has started
							// Close progress dialog if started
							if (response.message[0] != token) {
								$(".message-centered").hide();
								clearInterval(timer);
							}
					});
			}, frequency);
			
		}); */
		
		if(type =='xls'){
			$('#frmFilter').attr('action',"<c:url value='/time-cards/reportTimeCardOfProjectExcel.html'/>");
			$('#frmFilter').submit();
		}else if (type =='pdf'){
			$('#frmFilter').attr('action',"<c:url value='/time-cards/reportTimeCardOfProjectPDF.html'/>");
			$('#frmFilter').submit();
		}
		
		
	}
</script>

<div class="adminform">
	<div class="title"><spring:message code="legend.time_card.of_project" /></div>
	<div class="opr">		
		<form action="" id="frmFilter" class="form" id="filter" >
			<fieldset>
				<legend><spring:message code="lbl.filter"/></legend>
				<table class="form" cellspacing="0" cellpadding="0">
					<tr>
						<td class="label"><label for="projectId"><spring:message code="select.select_project"/></label><span class="required">*</span></td>
						<td class="input"><jsp:include page="/projects/selectProjectList.html?id=projectID&placeholder=Select a Project&width=250px"></jsp:include></td>
						<%-- <td class="input"><jsp:include page="/time-cards/reportTimeCardOfProjectAjaxByStaffID.html?id=projectID&StaffID=StaffID&placeholder=Select a Project&width=250px"></jsp:include></td> --%>
						<td>
						<td class="label"><label for="staffID"><spring:message code="select.select_employee"/></label></td>
						<td><select class="select-single" name="staffID" id="staffID" style="width: 250px"></select></td>
						<td class="input">
							<button id="btnPreview" class="search" style="margin-left:30px;"><spring:message code="button.preview"/></button>
						</td>
					</tr>
				</table>
			</fieldset>
		</form>
		<form class="form" action="">
			<fieldset>
				<legend><spring:message code="legend.time_card.of_project" /></legend>
				<div>
					<table id="timeCardList"></table>
					<div id="timeCardPage"></div>
				</div>
			</fieldset>
		</form>
	</div>
</div>
<div class="clr"></div>