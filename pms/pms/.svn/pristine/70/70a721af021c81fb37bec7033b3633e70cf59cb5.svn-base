<%@ page contentType="text/html; charset=utf-8" pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="spring" uri="http://www.springframework.org/tags" %>

<style type="text/css">
   .evenTableRow {
       background-color:#BBCCFF;color:#000;
       border:1px solid #BCBCBD;
   }
   .oddTableRow  {
       background-color:#E3E7F5;color:#000;
       border:1px solid #BCBCBD;
   }      
</style>
<script type="text/javascript">
	$(document).ready(function() {
		ModifyGridDefaultStyles=function() {  
			   $('#permissionList tr td:last-child').css("background-color","#BBCCFF");
			}
		$("#frmAdd").validationEngine();
		
		var lastsel;
		var addList = new Array();
		var removeList = new Array();
		
		var allFormatter = function(cellVal,options,rowObject) {
 			return "<input class='c_all_checkedbox' object='" + rowObject.entity +"' value=" + rowObject.all + (cellVal==true?" checked":" ") + " type='checkbox' />"
	    };
		var addFormatter = function(cellVal,options,rowObject) {
			if(rowObject.addCode==null) return "";
 			return "<input class='c_add c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.addCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var viewFormatter = function(cellVal,options,rowObject) {
			if(rowObject.viewCode==null) return "";
 			return "<input class='c_view c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.viewCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var updateFormatter = function(cellVal,options,rowObject) {
			if(rowObject.updateCode==null) return "";
 			return "<input class='c_update c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.updateCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var deleteFormatter = function(cellVal,options,rowObject) {
			if(rowObject.deleteCode==null) return "";
 			return "<input class='c_delete c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.deleteCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var entryFormatter = function(cellVal,options,rowObject) {
			if(rowObject.entryCode==null) return "";
 			return "<input class='c_entry c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.entryCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var unsubmitFormatter = function(cellVal,options,rowObject) {
			if(rowObject.unsubmitCode==null) return "";
 			return "<input class='c_unsubmit c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.unsubmitCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var enableAccountFormatter = function(cellVal,options,rowObject) {
			if(rowObject.accountCode==null) return "";
 			return "<input class='c_enableAccount c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.accountCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var resetPasswordFormatter = function(cellVal,options,rowObject) {
			if(rowObject.resetCode==null) return "";
 			return "<input class='c_resetPassword c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.resetCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
	    var reportFormatter = function(cellVal,options,rowObject) {
			if(rowObject.reportCode==null) return "";
 			return "<input class='c_report c_checkedbox c_"+rowObject.entity+"' object='" + rowObject.entity +"' value=" + rowObject.reportCode + (cellVal==true?" checked":" ") + " current_val='" + cellVal + "' type='checkbox' />"
	    };
		$("#permissionList").jqGrid(
						{
							url : "<c:url value='/auth/ajaxGrid.html?roleID=NEW_ROLE'/>",
							datatype : 'json',
							mtype : 'GET',
							colNames : [ '<spring:message code="th.object"/>', '<spring:message code="th.view"/>',
											'<spring:message code="th.add"/>','<spring:message code="th.update"/>','<spring:message code="th.delete"/>', '<spring:message code="th.entry"/>','<spring:message code="th.unsubmit"/>',
											'<spring:message code="th.enableAccount"/>','<spring:message code="th.reset_password"/>','<spring:message code="th.report"/>','<spring:message code="th.all"/>' ],
							colModel : [ {
								name : 'entity',
								index : 'entity',
								width : 150,
								sortable : false,
								search: false
							},  
							{
								name : 'view',
								index : 'view',
								formatter: viewFormatter,
								align: "center",
								width : 50, 
								sortable : false,
							},
							{
								name : 'add',
								index : 'add',
								formatter: addFormatter,
								align: "center",
								width : 50, 
								sortable : false,
							},
							{
								name : 'update',
								index : 'update',
								formatter: updateFormatter,
								align: "center",
								width : 50, 
								sortable : false,
							},
							{
								name : 'delete',
								index : 'delete',
								formatter: deleteFormatter,
								align: "center",
								width : 50, 
								sortable : false,

							}, 
							
							{
								name : 'entry',
								index : 'entry',
								formatter: entryFormatter,
								align: "center",
								width : 50, 
								sortable : false,
							}, 
							{
								name : 'unsubmit',
								index : 'unsubmit',
								formatter: unsubmitFormatter,
								align: "center",
								width : 50, 
								sortable : false,
							},
							{
								name : 'enableAccount',
								index : 'enableAccount',
								formatter: enableAccountFormatter,
								align: "center",
								width : 60, 
								sortable : false,
							},
							{
								name : 'resetPassword',
								index : 'resetPassword',
								formatter: resetPasswordFormatter,
								align: "center",
								width : 60, 
								sortable : false,
							},
							{
								name : 'report',
								index : 'report',
								formatter: reportFormatter,
								align: "center",
								width : 50, 
								sortable : false,
							},
							{
								name : 'all',
								index : 'all',
								formatter: allFormatter,
								align: "center",
								width : 50, 
								sortable : false,
							}],
							postData : {},
							rowNum : 9999,
							rowList : [ 10, 20, 40, 60, 100 ],
							height : 250,
							autowidth : true,
							editable: true,
							editurl:'clientArray',
							rownumbers : true,
							pager : '#permissionPage',
							sortable: false,
							viewrecords : true,
							select: false,
							hoverrows:false,
							caption : "",
							emptyrecords : "Empty records",
							loadonce : false,
							loadComplete : function() {
								var $this = $(this), ids = $this.jqGrid('getDataIDs'), i, l = ids.length;
							    for (i = 0; i < l; i++) {
							        $this.jqGrid('editRow', ids[i], true);
							    } 
							    ModifyGridDefaultStyles();
							},
							onSelectRow: function(id){
								$("#permissionList").jqGrid('editRow',id,true);

										lastsel=id; 
							},
							beforeSelectRow : function (){
							    return false;
							},
							jsonReader : {
								page : "page",
								total : "total",
								records : "records",
								root : "rows",
								repeatitems : false
							},
							gridComplete : function() {
								$(".c_checkedbox").change(function(){
									var pCode=$(this).attr("value");
									var object=$(this).attr("object");
									var allStatus;
									if($(this).is(":checked")){
										if($(this).attr("current_val")=="true")
											return;
										if(!removeList.remove(pCode))
											addList.add(pCode);
										$(this).attr("current_val","true");
										allStatus = ($(".c_view[object='" + object + "']").get(0)!==undefined?$(".c_view[object='" + object + "']").is(":checked"):true)
												 && ($(".c_add[object='" + object + "']").get(0)!==undefined?$(".c_add[object='" + object + "']").is(":checked"):true)
												 && ($(".c_update[object='" + object + "']").get(0)!==undefined?$(".c_update[object='" + object + "']").is(":checked"):true)
												 && ($(".c_delete[object='" + object + "']").get(0)!==undefined?$(".c_delete[object='" + object + "']").is(":checked"):true)
												 && ($(".c_entry[object='" + object + "']").get(0)!==undefined?$(".c_entry[object='" + object + "']").is(":checked"):true)
												 && ($(".c_unsubmit[object='" + object + "']").get(0)!==undefined?$(".c_unsubmit[object='" + object + "']").is(":checked"):true)
												 && ($(".c_enableAccount[object='" + object + "']").get(0)!==undefined?$(".c_enableAccount[object='" + object + "']").is(":checked"):true)
												 && ($(".c_resetPassword[object='" + object + "']").get(0)!==undefined?$(".c_resetPassword[object='" + object + "']").is(":checked"):true)
												 && ($(".c_report[object='" + object + "']").get(0)!==undefined?$(".c_report[object='" + object + "']").is(":checked"):true)
										
									}
									else{
																		
										if($(this).attr("current_val")=="false")
											return;
										if($(this).hasClass("c_view")){
											var sthChecked=$(".c_add[object='" + object + "']").is(":checked") 
												||$(".c_update[object='" + object + "']").is(":checked")
												||$(".c_delete[object='" + object + "']").is(":checked")
												||$(".c_enableAccount[object='" + object + "']").is(":checked")
												||$(".c_resetPassword[object='" + object + "']").is(":checked")
												||$(".c_report[object='" + object + "']").is(":checked");
											if(sthChecked)
											{	$(this).attr("checked",true);
												return true;
											}
										}
										
										if(!addList.remove(pCode))
											removeList.add(pCode);
										$(this).attr("current_val","false");
										allStatus=false;
									}
									$(".c_all_checkedbox[object='"+object+"']").attr("checked",allStatus);
										
								});
								$('.c_all_checkedbox').change(function(){
		                            	var object=".c_" + $(this).attr("object");
		                            	$(object).attr("checked",$(this).is(":checked")?true:false).trigger("change");
										 
				                 });
								$('.c_add,.c_update,.c_delete,.c_resetPassword,.c_enableAccount').change(function(){
									var object=$(this).attr("object");
									if($(this).is(":checked")){
										$(".c_view[object='"+object+"']").attr("checked",true).trigger("change");
									}
								});
							}
						});
		$(".btnSave").click(function(e){
			e.preventDefault();
			//alert(addList + "\n" + removeList);
			$("#addList").val(addList);
			$("#removeList").val(removeList);
			$("#save").val($(this).attr("value"));
			$("#frmAdd").submit();
		});
		
		
	});
	
</script>
<div class="adminform">
	<div class="break-crumbs">
		<a href="<c:url value='/roles/index.html' />"><img src="<c:url value='/images/icon/list.png' />" align="absmiddle" alt="" /><spring:message code='lbl.role_list'/></a>
	</div>
	<div class="opr">
		<form action="<c:url value='/roles/doAdd.html' />" id='frmAdd'
			method="post">
			<fieldset>
				<legend><spring:message code='lbl.add_new_role'/></legend>
				<table class="form" cellspacing="0" cellpadding="0">
					<tr>
						<td class="label"><label for="roleName"><spring:message code='th.role'/></label><span class="required">*</span></td>
						<td class="input"><input id="roleName" name="roleName"
							class="textfield validate[required,maxSize[50],ajax[ajaxCheckRole]]"
							type="text" /></td>
						<td class="label"></td>
						<td class="input"></td>
					</tr>
					<tr style="vertical-align: top;">
						<td class="label"><label for="description"><spring:message code='th.description'/></label></td>
						<td class="input" colspan="3"><textarea name="description"
								id="description" style="width: 100%;" class="textarea description"></textarea></td>
					</tr>
					<!-- <tr>
						<td colspan="4" class="button">
							<button class="save" name="save" value="save">Save</button>
							<button class="save" name="save" value="saveClose">Save & Close</button>
						</td>
					</tr> -->
				</table>
			</fieldset>
			<fieldset>
				<legend><spring:message code='lbl.permission_list'/></legend>
				<div>
					<table id="permissionList"></table>
					<div>
					<button class="btnSave save" value="save"><spring:message code='button.save'/></button>
					<button class="btnSave save" value="saveClose"><spring:message code='button.save_close'/></button>
					</div>
				</div>
			</fieldset>
			<input type="hidden" id="addList" name="addList"/>
			<input type="hidden" id="removeList" name="removeList"/>
			<input type="hidden" id="save" name="save"/>
		</form>
	</div>
</div>
<div class="clr"></div>